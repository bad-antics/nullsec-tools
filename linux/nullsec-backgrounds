#!/bin/bash
# ============================================================================
# NullSec Backgrounds - Custom Wallpaper Generator & Manager
# ============================================================================
# Generates procedural cybersecurity-themed wallpapers
# Licensed under NullSec Public License v1.0
# ============================================================================

VERSION="1.0.0"
WALLPAPER_DIR="$HOME/Pictures/NullSec"
CURRENT_LINK="$HOME/.local/share/nullsec/current-wallpaper"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
PURPLE='\033[0;35m'
NC='\033[0m'

banner() {
    echo -e "${CYAN}"
    cat << 'EOF'
    ╔═══════════════════════════════════════════════════════════════╗
    ║          NULLSEC BACKGROUNDS v1.0                             ║
    ║          Custom Wallpaper Generator                           ║
    ╚═══════════════════════════════════════════════════════════════╝
EOF
    echo -e "${NC}"
}

log() { echo -e "${GREEN}[✓]${NC} $1"; }
warn() { echo -e "${YELLOW}[!]${NC} $1"; }
error() { echo -e "${RED}[✗]${NC} $1"; exit 1; }
info() { echo -e "${BLUE}[i]${NC} $1"; }

init() {
    mkdir -p "$WALLPAPER_DIR"
    
    # Check for ImageMagick
    if ! command -v convert &>/dev/null; then
        warn "ImageMagick not found. Installing..."
        sudo apt install -y imagemagick 2>/dev/null || \
        sudo dnf install -y ImageMagick 2>/dev/null || \
        sudo pacman -S --noconfirm imagemagick 2>/dev/null || true
    fi
}

# Generate hex pattern
generate_hex_pattern() {
    local output="$WALLPAPER_DIR/nullsec-hex-$(date +%s).png"
    local width="${1:-1920}"
    local height="${2:-1080}"
    local color1="${3:-#0a0a0f}"
    local color2="${4:-#00ff41}"
    
    info "Generating hex matrix pattern..."
    
    # Create base with gradient
    convert -size "${width}x${height}" \
        -define gradient:angle=135 \
        gradient:"$color1"-"#0d1117" \
        "$output.base.png"
    
    # Generate hex characters
    local hex_text=""
    for i in $(seq 1 500); do
        hex_text+=$(printf '%02X ' $((RANDOM % 256)))
        [[ $((i % 32)) -eq 0 ]] && hex_text+="\n"
    done
    
    # Add hex overlay
    convert "$output.base.png" \
        -font "DejaVu-Sans-Mono" \
        -pointsize 12 \
        -fill "${color2}22" \
        -gravity center \
        -annotate +0+0 "$hex_text" \
        "$output.hex.png"
    
    # Add NullSec logo text
    convert "$output.hex.png" \
        -font "DejaVu-Sans-Mono-Bold" \
        -pointsize 72 \
        -fill "$color2" \
        -gravity center \
        -annotate +0-100 "NULLSEC" \
        -pointsize 24 \
        -fill "${color2}88" \
        -annotate +0+0 "LINUX" \
        -pointsize 14 \
        -fill "${color2}44" \
        -annotate +0+80 "Security • Privacy • Freedom" \
        "$output"
    
    rm -f "$output.base.png" "$output.hex.png"
    
    log "Generated: $output"
    echo "$output"
}

# Generate circuit board pattern
generate_circuit() {
    local output="$WALLPAPER_DIR/nullsec-circuit-$(date +%s).png"
    local width="${1:-1920}"
    local height="${2:-1080}"
    local bg_color="${3:-#0a0a12}"
    local line_color="${4:-#00ff41}"
    
    info "Generating circuit board pattern..."
    
    # Create base
    convert -size "${width}x${height}" xc:"$bg_color" "$output.base.png"
    
    # Create circuit pattern with random lines
    local draw_cmd=""
    for i in $(seq 1 100); do
        local x1=$((RANDOM % width))
        local y1=$((RANDOM % height))
        local x2=$((x1 + (RANDOM % 200) - 100))
        local y2=$((y1 + (RANDOM % 200) - 100))
        draw_cmd+="line $x1,$y1 $x2,$y2 "
    done
    
    # Add nodes
    for i in $(seq 1 50); do
        local x=$((RANDOM % width))
        local y=$((RANDOM % height))
        local r=$((RANDOM % 5 + 2))
        draw_cmd+="circle $x,$y $((x+r)),$y "
    done
    
    convert "$output.base.png" \
        -stroke "${line_color}44" \
        -strokewidth 1 \
        -fill "${line_color}22" \
        -draw "$draw_cmd" \
        "$output.circuit.png"
    
    # Add center logo
    convert "$output.circuit.png" \
        -font "DejaVu-Sans-Mono-Bold" \
        -pointsize 96 \
        -fill "$line_color" \
        -stroke "${line_color}88" \
        -strokewidth 2 \
        -gravity center \
        -annotate +0+0 "N U L L S E C" \
        "$output"
    
    rm -f "$output.base.png" "$output.circuit.png"
    
    log "Generated: $output"
    echo "$output"
}

# Generate matrix rain
generate_matrix() {
    local output="$WALLPAPER_DIR/nullsec-matrix-$(date +%s).png"
    local width="${1:-1920}"
    local height="${2:-1080}"
    
    info "Generating matrix rain pattern..."
    
    # Create black base
    convert -size "${width}x${height}" xc:"#000000" "$output.base.png"
    
    # Generate columns of characters
    local cols=$((width / 20))
    local draw_cmd=""
    
    for col in $(seq 1 $cols); do
        local x=$((col * 20))
        local stream_height=$((RANDOM % height))
        local y_start=$((RANDOM % (height - stream_height)))
        
        for y in $(seq $y_start $((y_start + stream_height)) ); do
            if [[ $((y % 20)) -eq 0 ]]; then
                local char=$(printf "\x$(printf '%02x' $((RANDOM % 94 + 33)))")
                local brightness=$((255 - (y - y_start) * 255 / stream_height))
                [[ $brightness -lt 30 ]] && brightness=30
                local color=$(printf "#00%02x00" $brightness)
                draw_cmd+="fill '$color' text $x,$y '$char' "
            fi
        done
    done
    
    convert "$output.base.png" \
        -font "DejaVu-Sans-Mono" \
        -pointsize 14 \
        -draw "$draw_cmd" \
        "$output.matrix.png" 2>/dev/null || cp "$output.base.png" "$output.matrix.png"
    
    # Add logo with glow
    convert "$output.matrix.png" \
        \( -size "${width}x${height}" xc:none \
           -font "DejaVu-Sans-Mono-Bold" \
           -pointsize 120 \
           -fill "#00ff00" \
           -gravity center \
           -annotate +0+0 "NULLSEC" \
           -blur 0x8 \) \
        -composite \
        -font "DejaVu-Sans-Mono-Bold" \
        -pointsize 120 \
        -fill "#00ff41" \
        -gravity center \
        -annotate +0+0 "NULLSEC" \
        "$output"
    
    rm -f "$output.base.png" "$output.matrix.png"
    
    log "Generated: $output"
    echo "$output"
}

# Generate gradient with logo
generate_gradient() {
    local output="$WALLPAPER_DIR/nullsec-gradient-$(date +%s).png"
    local width="${1:-1920}"
    local height="${2:-1080}"
    local style="${3:-cyber}"
    
    info "Generating gradient wallpaper (style: $style)..."
    
    case "$style" in
        cyber)
            local color1="#0a0a0f"
            local color2="#001a00"
            local accent="#00ff41"
            ;;
        dark)
            local color1="#0d0d0d"
            local color2="#1a1a2e"
            local accent="#e94560"
            ;;
        purple)
            local color1="#0f0f1a"
            local color2="#1a0a2e"
            local accent="#bd00ff"
            ;;
        blue)
            local color1="#0a0a1a"
            local color2="#001a33"
            local accent="#00d4ff"
            ;;
        red)
            local color1="#0f0a0a"
            local color2="#1a0000"
            local accent="#ff0040"
            ;;
        *)
            local color1="#0a0a0f"
            local color2="#001a00"
            local accent="#00ff41"
            ;;
    esac
    
    # Create gradient
    convert -size "${width}x${height}" \
        -define gradient:angle=135 \
        gradient:"$color1"-"$color2" \
        "$output.base.png"
    
    # Add subtle grid
    convert "$output.base.png" \
        -stroke "${accent}11" \
        -strokewidth 1 \
        -draw "$(for x in $(seq 0 50 $width); do echo -n "line $x,0 $x,$height "; done)" \
        -draw "$(for y in $(seq 0 50 $height); do echo -n "line 0,$y $width,$y "; done)" \
        "$output.grid.png"
    
    # Add logo
    convert "$output.grid.png" \
        \( -size "${width}x${height}" xc:none \
           -font "DejaVu-Sans-Mono-Bold" \
           -pointsize 100 \
           -fill "$accent" \
           -gravity center \
           -annotate +0-50 "NULLSEC" \
           -blur 0x5 \) \
        -composite \
        -font "DejaVu-Sans-Mono-Bold" \
        -pointsize 100 \
        -fill "$accent" \
        -gravity center \
        -annotate +0-50 "NULLSEC" \
        -pointsize 28 \
        -fill "${accent}aa" \
        -annotate +0+50 "L I N U X   1 . 0" \
        "$output"
    
    rm -f "$output.base.png" "$output.grid.png"
    
    log "Generated: $output"
    echo "$output"
}

# Generate minimal wallpaper
generate_minimal() {
    local output="$WALLPAPER_DIR/nullsec-minimal-$(date +%s).png"
    local width="${1:-1920}"
    local height="${2:-1080}"
    local bg="${3:-#0a0a0f}"
    local fg="${4:-#00ff41}"
    
    info "Generating minimal wallpaper..."
    
    convert -size "${width}x${height}" xc:"$bg" \
        -font "DejaVu-Sans-Mono-Bold" \
        -pointsize 48 \
        -fill "$fg" \
        -gravity center \
        -annotate +0+0 "[ NULLSEC ]" \
        "$output"
    
    log "Generated: $output"
    echo "$output"
}

# Generate all default wallpapers
generate_all() {
    banner
    info "Generating complete wallpaper collection..."
    echo ""
    
    generate_gradient 1920 1080 cyber
    generate_gradient 1920 1080 dark
    generate_gradient 1920 1080 purple
    generate_gradient 1920 1080 blue
    generate_gradient 1920 1080 red
    generate_minimal 1920 1080
    generate_hex_pattern 1920 1080
    generate_circuit 1920 1080
    
    echo ""
    log "Generated $(ls "$WALLPAPER_DIR"/*.png 2>/dev/null | wc -l) wallpapers"
    info "Location: $WALLPAPER_DIR"
}

# Set wallpaper
set_wallpaper() {
    local wallpaper="$1"
    
    [[ ! -f "$wallpaper" ]] && error "File not found: $wallpaper"
    
    info "Setting wallpaper: $(basename "$wallpaper")"
    
    # Update current link
    ln -sf "$wallpaper" "$CURRENT_LINK"
    
    # Try various desktop environments
    if command -v gsettings &>/dev/null; then
        gsettings set org.gnome.desktop.background picture-uri "file://$wallpaper" 2>/dev/null
        gsettings set org.gnome.desktop.background picture-uri-dark "file://$wallpaper" 2>/dev/null
    fi
    
    if command -v xfconf-query &>/dev/null; then
        xfconf-query -c xfce4-desktop -p /backdrop/screen0/monitor0/workspace0/last-image -s "$wallpaper" 2>/dev/null
    fi
    
    if command -v pcmanfm &>/dev/null; then
        pcmanfm --set-wallpaper="$wallpaper" 2>/dev/null
    fi
    
    if command -v feh &>/dev/null; then
        feh --bg-fill "$wallpaper" 2>/dev/null
    fi
    
    if command -v nitrogen &>/dev/null; then
        nitrogen --set-zoom-fill "$wallpaper" 2>/dev/null
    fi
    
    log "Wallpaper set"
}

# Set random wallpaper
random_wallpaper() {
    local wallpapers=("$WALLPAPER_DIR"/*.png)
    
    if [[ ${#wallpapers[@]} -eq 0 ]]; then
        warn "No wallpapers found. Generating..."
        generate_all
        wallpapers=("$WALLPAPER_DIR"/*.png)
    fi
    
    local random_wp="${wallpapers[RANDOM % ${#wallpapers[@]}]}"
    set_wallpaper "$random_wp"
}

# List wallpapers
list_wallpapers() {
    banner
    info "Available wallpapers:"
    echo ""
    
    local count=0
    for wp in "$WALLPAPER_DIR"/*.png; do
        [[ ! -f "$wp" ]] && continue
        ((count++))
        local size=$(du -h "$wp" | cut -f1)
        local current=""
        [[ "$(readlink "$CURRENT_LINK" 2>/dev/null)" == "$wp" ]] && current=" ${GREEN}(current)${NC}"
        echo -e "  $count. $(basename "$wp") [$size]$current"
    done
    
    if [[ $count -eq 0 ]]; then
        warn "No wallpapers found. Run 'nullsec-backgrounds generate' to create some."
    else
        echo ""
        log "Total: $count wallpapers"
    fi
}

# Slideshow mode
slideshow() {
    local interval="${1:-300}"
    
    banner
    info "Starting slideshow (interval: ${interval}s)"
    info "Press Ctrl+C to stop"
    echo ""
    
    while true; do
        random_wallpaper
        sleep "$interval"
    done
}

# Help
show_help() {
    banner
    cat << 'HELP'
USAGE:
    nullsec-backgrounds <command> [options]

GENERATE COMMANDS:
    generate            Generate all default wallpapers
    gradient [style]    Generate gradient (cyber/dark/purple/blue/red)
    minimal             Generate minimal wallpaper
    hex                 Generate hex matrix pattern
    circuit             Generate circuit board pattern
    matrix              Generate matrix rain pattern

WALLPAPER COMMANDS:
    set <file>          Set specific wallpaper
    random              Set random wallpaper
    list                List available wallpapers
    slideshow [secs]    Rotate wallpapers (default: 300s)

OPTIONS:
    -w, --width         Width in pixels (default: 1920)
    -h, --height        Height in pixels (default: 1080)

STYLES:
    cyber   - Green on black (default)
    dark    - Red on dark
    purple  - Purple/magenta theme
    blue    - Cyan/blue theme
    red     - Red/crimson theme

EXAMPLES:
    nullsec-backgrounds generate
    nullsec-backgrounds gradient purple
    nullsec-backgrounds set ~/Pictures/custom.png
    nullsec-backgrounds slideshow 600
    nullsec-backgrounds random

LICENSE:
    NullSec Public License v1.0

HELP
}

# Main
main() {
    init
    
    case "${1:-help}" in
        generate|gen|all)
            generate_all
            ;;
        gradient|grad)
            banner
            generate_gradient 1920 1080 "${2:-cyber}"
            ;;
        minimal|min)
            banner
            generate_minimal 1920 1080
            ;;
        hex)
            banner
            generate_hex_pattern 1920 1080
            ;;
        circuit)
            banner
            generate_circuit 1920 1080
            ;;
        matrix)
            banner
            generate_matrix 1920 1080
            ;;
        set)
            banner
            set_wallpaper "$2"
            ;;
        random|rand)
            banner
            random_wallpaper
            ;;
        list|ls)
            list_wallpapers
            ;;
        slideshow|slide)
            slideshow "${2:-300}"
            ;;
        *)
            show_help
            ;;
    esac
}

main "$@"
