#!/bin/bash
# NullSec Process Monitor
# System process analysis and monitoring
# License: MIT

VERSION="1.0.0"
SCRIPT_NAME=$(basename "$0")

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
CYAN='\033[0;36m'
NC='\033[0m'

usage() {
    cat << HELP
${CYAN}NullSec Process Monitor v${VERSION}${NC}

Usage: $SCRIPT_NAME <command> [options]

Commands:
  list                List all processes
  tree                Process tree
  top [n]             Top N processes by CPU (default: 15)
  mem [n]             Top N processes by memory (default: 15)
  find <pattern>      Find processes matching pattern
  info <pid>          Detailed process info
  files <pid>         Open files for PID
  net <pid>           Network connections for PID
  watch <pattern>     Watch for process (notify on start/stop)
  suspicious          Find potentially suspicious processes
  hidden              Check for hidden processes

Examples:
  $SCRIPT_NAME top 10
  $SCRIPT_NAME find nginx
  $SCRIPT_NAME info 1234
  $SCRIPT_NAME suspicious

HELP
}

list_processes() {
    ps auxf --sort=-pcpu | head -50
}

process_tree() {
    pstree -pul 2>/dev/null || ps auxf
}

top_cpu() {
    local n="${1:-15}"
    echo -e "${CYAN}═══ Top $n Processes by CPU ═══${NC}\n"
    ps aux --sort=-pcpu | head -$((n + 1))
}

top_mem() {
    local n="${1:-15}"
    echo -e "${CYAN}═══ Top $n Processes by Memory ═══${NC}\n"
    ps aux --sort=-rss | head -$((n + 1))
}

find_process() {
    local pattern="$1"
    [[ -z "$pattern" ]] && { echo -e "${RED}Pattern required${NC}"; exit 1; }
    
    echo -e "${CYAN}═══ Processes matching: $pattern ═══${NC}\n"
    ps aux | grep -E "$pattern" | grep -v "grep"
}

process_info() {
    local pid="$1"
    [[ -z "$pid" ]] && { echo -e "${RED}PID required${NC}"; exit 1; }
    [[ ! -d "/proc/$pid" ]] && { echo -e "${RED}Process $pid not found${NC}"; exit 1; }
    
    echo -e "${CYAN}═══ Process Info: PID $pid ═══${NC}\n"
    
    echo -e "${GREEN}Command:${NC}"
    cat /proc/$pid/cmdline 2>/dev/null | tr '\0' ' '
    echo -e "\n"
    
    echo -e "${GREEN}Status:${NC}"
    cat /proc/$pid/status 2>/dev/null | grep -E "^(Name|State|Pid|PPid|Uid|Gid|VmSize|VmRSS|Threads):"
    echo ""
    
    echo -e "${GREEN}CWD:${NC} $(readlink /proc/$pid/cwd 2>/dev/null)"
    echo -e "${GREEN}Exe:${NC} $(readlink /proc/$pid/exe 2>/dev/null)"
    echo ""
    
    echo -e "${GREEN}Environment (first 10):${NC}"
    cat /proc/$pid/environ 2>/dev/null | tr '\0' '\n' | head -10
}

process_files() {
    local pid="$1"
    [[ -z "$pid" ]] && { echo -e "${RED}PID required${NC}"; exit 1; }
    
    echo -e "${CYAN}═══ Open Files: PID $pid ═══${NC}\n"
    ls -la /proc/$pid/fd 2>/dev/null | head -30
    echo ""
    lsof -p "$pid" 2>/dev/null | head -30
}

process_net() {
    local pid="$1"
    [[ -z "$pid" ]] && { echo -e "${RED}PID required${NC}"; exit 1; }
    
    echo -e "${CYAN}═══ Network Connections: PID $pid ═══${NC}\n"
    
    # Using ss
    ss -tunapl 2>/dev/null | grep "pid=$pid" || \
    # Fallback to netstat
    netstat -tunapl 2>/dev/null | grep "$pid/" || \
    # Fallback to lsof
    lsof -i -a -p "$pid" 2>/dev/null
}

watch_process() {
    local pattern="$1"
    [[ -z "$pattern" ]] && { echo -e "${RED}Pattern required${NC}"; exit 1; }
    
    echo -e "${CYAN}═══ Watching for: $pattern ═══${NC}"
    echo "Press Ctrl+C to stop"
    echo ""
    
    local last_pids=""
    while true; do
        local current_pids=$(pgrep -f "$pattern" 2>/dev/null | sort | tr '\n' ' ')
        
        if [[ "$current_pids" != "$last_pids" ]]; then
            if [[ -n "$current_pids" ]]; then
                echo -e "[$(date '+%H:%M:%S')] ${GREEN}FOUND:${NC} PIDs: $current_pids"
            else
                echo -e "[$(date '+%H:%M:%S')] ${YELLOW}NOT RUNNING${NC}"
            fi
            last_pids="$current_pids"
        fi
        
        sleep 2
    done
}

suspicious_processes() {
    echo -e "${CYAN}═══ Suspicious Process Analysis ═══${NC}\n"
    
    # Processes with deleted executables
    echo -e "${GREEN}Processes with deleted executables:${NC}"
    ls -la /proc/*/exe 2>/dev/null | grep "(deleted)" | while read line; do
        pid=$(echo "$line" | grep -oP '/proc/\K[0-9]+')
        echo "  PID $pid: $(cat /proc/$pid/cmdline 2>/dev/null | tr '\0' ' ')"
    done
    echo ""
    
    # Processes running from /tmp, /dev/shm, or hidden dirs
    echo -e "${GREEN}Processes from suspicious locations:${NC}"
    ps aux | awk '$11 ~ /^\/(tmp|dev\/shm|var\/tmp)/ || $11 ~ /\/\./' | grep -v "grep"
    echo ""
    
    # Processes with no associated terminal spawning network connections
    echo -e "${GREEN}Network processes without terminal:${NC}"
    ps aux | awk '$7 == "?" {print}' | while read line; do
        pid=$(echo "$line" | awk '{print $2}')
        if ss -tunapl 2>/dev/null | grep -q "pid=$pid"; then
            echo "  $line"
        fi
    done | head -10
    echo ""
    
    # High CPU processes running as root
    echo -e "${GREEN}High CPU processes (>50%) as root:${NC}"
    ps aux | awk '$1 == "root" && $3 > 50 {print}'
}

hidden_processes() {
    echo -e "${CYAN}═══ Hidden Process Check ═══${NC}\n"
    
    # Compare /proc with ps output
    local proc_pids=$(ls -d /proc/[0-9]* 2>/dev/null | xargs -n1 basename | sort -n)
    local ps_pids=$(ps -eo pid --no-headers | tr -d ' ' | sort -n)
    
    echo -e "${GREEN}Checking for discrepancies between /proc and ps...${NC}"
    
    local hidden=0
    for pid in $proc_pids; do
        if ! echo "$ps_pids" | grep -qx "$pid"; then
            echo -e "${RED}Potential hidden PID: $pid${NC}"
            echo "  Cmdline: $(cat /proc/$pid/cmdline 2>/dev/null | tr '\0' ' ')"
            ((hidden++))
        fi
    done
    
    if [[ $hidden -eq 0 ]]; then
        echo -e "${GREEN}✓ No hidden processes detected${NC}"
    else
        echo -e "\n${YELLOW}Found $hidden potentially hidden processes${NC}"
    fi
}

# Main
case "${1:-help}" in
    list)       list_processes ;;
    tree)       process_tree ;;
    top)        top_cpu "$2" ;;
    mem)        top_mem "$2" ;;
    find)       find_process "$2" ;;
    info)       process_info "$2" ;;
    files)      process_files "$2" ;;
    net)        process_net "$2" ;;
    watch)      watch_process "$2" ;;
    suspicious) suspicious_processes ;;
    hidden)     hidden_processes ;;
    -v|--version) echo "NullSec Process Monitor v${VERSION}" ;;
    help|-h|--help|*) usage ;;
esac
