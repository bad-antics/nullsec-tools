#!/usr/bin/env python3
"""
NullSec Harden - System Security Hardener
=========================================
Automated security hardening for NullSec Linux.

Hardens:
- Kernel parameters (sysctl)
- Network stack
- Filesystem permissions
- Service configuration
- SSH security
- Firewall rules

(c) bad-antics development
"""

import os
import sys
import argparse
import subprocess
import shutil
from pathlib import Path
from typing import List, Dict, Tuple, Optional

# ============================================================================
# Colors
# ============================================================================

class C:
    RST = '\033[0m'
    BLD = '\033[1m'
    DIM = '\033[2m'
    RED = '\033[0;31m'
    GRN = '\033[0;32m'
    YLW = '\033[0;33m'
    CYN = '\033[0;36m'

# ============================================================================
# Hardening Rules
# ============================================================================

SYSCTL_HARDENING = {
    # Network security
    "net.ipv4.tcp_syncookies": "1",
    "net.ipv4.conf.all.rp_filter": "1",
    "net.ipv4.conf.default.rp_filter": "1",
    "net.ipv4.conf.all.accept_redirects": "0",
    "net.ipv4.conf.default.accept_redirects": "0",
    "net.ipv4.conf.all.send_redirects": "0",
    "net.ipv4.conf.default.send_redirects": "0",
    "net.ipv4.conf.all.accept_source_route": "0",
    "net.ipv4.conf.default.accept_source_route": "0",
    "net.ipv4.icmp_echo_ignore_broadcasts": "1",
    "net.ipv4.icmp_ignore_bogus_error_responses": "1",
    "net.ipv4.conf.all.log_martians": "1",
    "net.ipv4.conf.default.log_martians": "1",
    
    # IPv6 hardening
    "net.ipv6.conf.all.accept_redirects": "0",
    "net.ipv6.conf.default.accept_redirects": "0",
    "net.ipv6.conf.all.accept_source_route": "0",
    "net.ipv6.conf.default.accept_source_route": "0",
    
    # Kernel hardening
    "kernel.randomize_va_space": "2",
    "kernel.kptr_restrict": "2",
    "kernel.dmesg_restrict": "1",
    "kernel.perf_event_paranoid": "3",
    "kernel.yama.ptrace_scope": "2",
    "kernel.unprivileged_bpf_disabled": "1",
    "kernel.sysrq": "0",
    
    # Filesystem hardening
    "fs.protected_hardlinks": "1",
    "fs.protected_symlinks": "1",
    "fs.protected_fifos": "2",
    "fs.protected_regular": "2",
    "fs.suid_dumpable": "0",
}

SSH_HARDENING = {
    "PermitRootLogin": "no",
    "PasswordAuthentication": "no",
    "PubkeyAuthentication": "yes",
    "PermitEmptyPasswords": "no",
    "X11Forwarding": "no",
    "MaxAuthTries": "3",
    "ClientAliveInterval": "300",
    "ClientAliveCountMax": "2",
    "LoginGraceTime": "60",
    "AllowAgentForwarding": "no",
    "AllowTcpForwarding": "no",
    "Protocol": "2",
    "Ciphers": "chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com",
    "MACs": "hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com",
    "KexAlgorithms": "curve25519-sha256,curve25519-sha256@libssh.org",
}

DANGEROUS_SERVICES = [
    "telnet",
    "rsh",
    "rlogin",
    "rexec",
    "tftp",
    "talk",
    "ntalk",
    "xinetd",
    "avahi-daemon",
    "cups",
]

SECURE_PERMISSIONS = [
    ("/etc/passwd", 0o644),
    ("/etc/shadow", 0o600),
    ("/etc/group", 0o644),
    ("/etc/gshadow", 0o600),
    ("/etc/ssh/sshd_config", 0o600),
    ("/etc/crontab", 0o600),
    ("/etc/sudoers", 0o440),
    ("/var/log", 0o750),
]

# ============================================================================
# Hardening Functions
# ============================================================================

def run_cmd(cmd: List[str], check: bool = True) -> Tuple[int, str, str]:
    """Run a command and return (returncode, stdout, stderr)."""
    try:
        result = subprocess.run(cmd, capture_output=True, text=True)
        return result.returncode, result.stdout, result.stderr
    except Exception as e:
        return 1, '', str(e)


def backup_file(filepath: str) -> bool:
    """Create a backup of a file."""
    if os.path.exists(filepath):
        backup_path = f"{filepath}.nullsec.bak"
        try:
            shutil.copy2(filepath, backup_path)
            return True
        except Exception:
            return False
    return True


def apply_sysctl(dry_run: bool = False, verbose: bool = False) -> Tuple[int, int]:
    """Apply kernel hardening via sysctl."""
    applied = 0
    failed = 0
    
    config_file = "/etc/sysctl.d/99-nullsec-hardening.conf"
    
    if not dry_run:
        backup_file(config_file)
        
        try:
            with open(config_file, 'w') as f:
                f.write("# NullSec Security Hardening\n")
                f.write("# Generated by nullsec-harden\n\n")
                
                for key, value in SYSCTL_HARDENING.items():
                    f.write(f"{key} = {value}\n")
                    
                    if verbose:
                        print(f"  {C.DIM}Setting {key} = {value}{C.RST}")
                    
                    applied += 1
            
            # Apply immediately
            run_cmd(['sysctl', '--system'], check=False)
            
        except PermissionError:
            print(f"  {C.RED}[!] Permission denied - run as root{C.RST}")
            return 0, len(SYSCTL_HARDENING)
        except Exception as e:
            print(f"  {C.RED}[!] Error: {e}{C.RST}")
            return 0, len(SYSCTL_HARDENING)
    else:
        for key, value in SYSCTL_HARDENING.items():
            print(f"  {C.DIM}Would set: {key} = {value}{C.RST}")
            applied += 1
    
    return applied, failed


def harden_ssh(dry_run: bool = False, verbose: bool = False) -> Tuple[int, int]:
    """Harden SSH configuration."""
    applied = 0
    failed = 0
    
    ssh_config = "/etc/ssh/sshd_config"
    
    if not os.path.exists(ssh_config):
        print(f"  {C.YLW}[!] SSH config not found - skipping{C.RST}")
        return 0, 0
    
    if not dry_run:
        backup_file(ssh_config)
        
        try:
            # Read current config
            with open(ssh_config, 'r') as f:
                lines = f.readlines()
            
            # Create new config
            new_lines = []
            processed_keys = set()
            
            for line in lines:
                stripped = line.strip()
                
                # Skip comments and empty lines
                if not stripped or stripped.startswith('#'):
                    new_lines.append(line)
                    continue
                
                # Check if this is a setting we want to harden
                parts = stripped.split(None, 1)
                if parts:
                    key = parts[0]
                    if key in SSH_HARDENING:
                        new_lines.append(f"{key} {SSH_HARDENING[key]}\n")
                        processed_keys.add(key)
                        applied += 1
                        if verbose:
                            print(f"  {C.DIM}Updated: {key} = {SSH_HARDENING[key]}{C.RST}")
                    else:
                        new_lines.append(line)
            
            # Add any missing hardening settings
            new_lines.append("\n# NullSec Security Hardening\n")
            for key, value in SSH_HARDENING.items():
                if key not in processed_keys:
                    new_lines.append(f"{key} {value}\n")
                    applied += 1
                    if verbose:
                        print(f"  {C.DIM}Added: {key} = {value}{C.RST}")
            
            # Write new config
            with open(ssh_config, 'w') as f:
                f.writelines(new_lines)
            
            # Restart SSH service
            run_cmd(['systemctl', 'restart', 'sshd'], check=False)
            
        except PermissionError:
            print(f"  {C.RED}[!] Permission denied - run as root{C.RST}")
            return 0, len(SSH_HARDENING)
        except Exception as e:
            print(f"  {C.RED}[!] Error: {e}{C.RST}")
            failed = len(SSH_HARDENING) - applied
    else:
        for key, value in SSH_HARDENING.items():
            print(f"  {C.DIM}Would set: {key} = {value}{C.RST}")
            applied += 1
    
    return applied, failed


def disable_services(dry_run: bool = False, verbose: bool = False) -> Tuple[int, int]:
    """Disable dangerous services."""
    disabled = 0
    skipped = 0
    
    for service in DANGEROUS_SERVICES:
        # Check if service exists
        ret, out, err = run_cmd(['systemctl', 'status', service])
        
        if 'could not be found' in err.lower() or 'not-found' in out.lower():
            skipped += 1
            continue
        
        if dry_run:
            print(f"  {C.DIM}Would disable: {service}{C.RST}")
            disabled += 1
        else:
            if verbose:
                print(f"  {C.DIM}Disabling: {service}{C.RST}")
            
            run_cmd(['systemctl', 'stop', service], check=False)
            run_cmd(['systemctl', 'disable', service], check=False)
            run_cmd(['systemctl', 'mask', service], check=False)
            disabled += 1
    
    return disabled, skipped


def set_permissions(dry_run: bool = False, verbose: bool = False) -> Tuple[int, int]:
    """Set secure file permissions."""
    fixed = 0
    failed = 0
    
    for filepath, mode in SECURE_PERMISSIONS:
        if not os.path.exists(filepath):
            continue
        
        try:
            current_mode = os.stat(filepath).st_mode & 0o777
            
            if current_mode != mode:
                if dry_run:
                    print(f"  {C.DIM}Would chmod {oct(mode)} {filepath}{C.RST}")
                else:
                    if verbose:
                        print(f"  {C.DIM}chmod {oct(mode)} {filepath}{C.RST}")
                    os.chmod(filepath, mode)
                fixed += 1
        except PermissionError:
            failed += 1
        except Exception:
            failed += 1
    
    return fixed, failed


def setup_firewall(dry_run: bool = False, verbose: bool = False) -> bool:
    """Configure basic firewall rules."""
    
    # Check for iptables or nftables
    has_iptables = shutil.which('iptables') is not None
    has_nft = shutil.which('nft') is not None
    
    if not has_iptables and not has_nft:
        print(f"  {C.YLW}[!] No firewall tool found - skipping{C.RST}")
        return False
    
    if dry_run:
        print(f"  {C.DIM}Would configure firewall rules:{C.RST}")
        print(f"  {C.DIM}  - Allow established connections{C.RST}")
        print(f"  {C.DIM}  - Allow loopback{C.RST}")
        print(f"  {C.DIM}  - Drop invalid packets{C.RST}")
        print(f"  {C.DIM}  - Limit SSH attempts{C.RST}")
        return True
    
    if has_iptables:
        rules = [
            # Flush existing rules
            ['iptables', '-F'],
            ['iptables', '-X'],
            
            # Default policies
            ['iptables', '-P', 'INPUT', 'DROP'],
            ['iptables', '-P', 'FORWARD', 'DROP'],
            ['iptables', '-P', 'OUTPUT', 'ACCEPT'],
            
            # Allow established
            ['iptables', '-A', 'INPUT', '-m', 'conntrack', '--ctstate', 
             'ESTABLISHED,RELATED', '-j', 'ACCEPT'],
            
            # Allow loopback
            ['iptables', '-A', 'INPUT', '-i', 'lo', '-j', 'ACCEPT'],
            
            # Drop invalid
            ['iptables', '-A', 'INPUT', '-m', 'conntrack', '--ctstate', 
             'INVALID', '-j', 'DROP'],
            
            # Rate limit SSH
            ['iptables', '-A', 'INPUT', '-p', 'tcp', '--dport', '22', '-m', 
             'conntrack', '--ctstate', 'NEW', '-m', 'limit', '--limit', 
             '3/min', '--limit-burst', '3', '-j', 'ACCEPT'],
            
            # Drop everything else to SSH
            ['iptables', '-A', 'INPUT', '-p', 'tcp', '--dport', '22', '-j', 'DROP'],
            
            # Log dropped packets (limited)
            ['iptables', '-A', 'INPUT', '-m', 'limit', '--limit', '5/min', 
             '-j', 'LOG', '--log-prefix', 'NullSec-Dropped: '],
        ]
        
        for rule in rules:
            if verbose:
                print(f"  {C.DIM}{' '.join(rule)}{C.RST}")
            run_cmd(rule, check=False)
        
        return True
    
    return False


def audit_system(verbose: bool = False) -> Dict[str, List[str]]:
    """Audit current system security state."""
    findings = {
        'critical': [],
        'warning': [],
        'info': [],
    }
    
    # Check for root login
    try:
        with open('/etc/ssh/sshd_config', 'r') as f:
            config = f.read()
            if 'PermitRootLogin yes' in config:
                findings['critical'].append("SSH root login is enabled")
    except Exception:
        pass
    
    # Check for empty passwords
    try:
        with open('/etc/shadow', 'r') as f:
            for line in f:
                parts = line.split(':')
                if len(parts) > 1 and not parts[1]:
                    findings['critical'].append(f"User {parts[0]} has no password")
    except Exception:
        pass
    
    # Check ASLR
    try:
        with open('/proc/sys/kernel/randomize_va_space', 'r') as f:
            if f.read().strip() != '2':
                findings['warning'].append("ASLR is not fully enabled")
    except Exception:
        pass
    
    # Check for world-writable files in /etc
    try:
        ret, out, err = run_cmd(['find', '/etc', '-perm', '-002', '-type', 'f'])
        if out.strip():
            for line in out.strip().split('\n')[:5]:
                findings['warning'].append(f"World-writable: {line}")
    except Exception:
        pass
    
    # Check running services
    ret, out, err = run_cmd(['systemctl', 'list-units', '--type=service', 
                            '--state=running', '--no-pager'])
    for service in DANGEROUS_SERVICES:
        if service in out:
            findings['warning'].append(f"Dangerous service running: {service}")
    
    # Check firewall status
    ret, out, err = run_cmd(['iptables', '-L', '-n'])
    if 'policy ACCEPT' in out:
        findings['warning'].append("Firewall has permissive default policy")
    
    return findings


# ============================================================================
# CLI Interface
# ============================================================================

def print_banner():
    """Print application banner."""
    print(f"""
{C.CYN}  ╔═══════════════════════════════════════════════════════════╗
  ║                   NULLSEC HARDEN                          ║
  ║              System Security Hardener                     ║
  ╚═══════════════════════════════════════════════════════════╝{C.RST}
""")


def main():
    """Main entry point."""
    parser = argparse.ArgumentParser(
        description='NullSec Harden - System Security Hardener',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  %(prog)s --audit           # Audit current security state
  %(prog)s --all             # Apply all hardening (requires root)
  %(prog)s --sysctl          # Harden kernel parameters
  %(prog)s --ssh             # Harden SSH configuration
  %(prog)s --dry-run --all   # Preview all changes
        """
    )
    
    parser.add_argument('--audit', action='store_true',
                        help='Audit current security state')
    parser.add_argument('--all', action='store_true',
                        help='Apply all hardening measures')
    parser.add_argument('--sysctl', action='store_true',
                        help='Harden kernel parameters')
    parser.add_argument('--ssh', action='store_true',
                        help='Harden SSH configuration')
    parser.add_argument('--services', action='store_true',
                        help='Disable dangerous services')
    parser.add_argument('--permissions', action='store_true',
                        help='Fix file permissions')
    parser.add_argument('--firewall', action='store_true',
                        help='Configure firewall')
    parser.add_argument('--dry-run', action='store_true',
                        help='Show what would be done without making changes')
    parser.add_argument('-v', '--verbose', action='store_true',
                        help='Verbose output')
    
    args = parser.parse_args()
    
    print_banner()
    
    # Audit mode
    if args.audit:
        print(f"  {C.BLD}Security Audit{C.RST}")
        print(f"  {C.DIM}{'─' * 55}{C.RST}\n")
        
        findings = audit_system(args.verbose)
        
        if findings['critical']:
            print(f"  {C.RED}CRITICAL:{C.RST}")
            for f in findings['critical']:
                print(f"    {C.RED}✗{C.RST} {f}")
            print()
        
        if findings['warning']:
            print(f"  {C.YLW}WARNINGS:{C.RST}")
            for f in findings['warning']:
                print(f"    {C.YLW}!{C.RST} {f}")
            print()
        
        if findings['info']:
            print(f"  {C.CYN}INFO:{C.RST}")
            for f in findings['info']:
                print(f"    {C.CYN}i{C.RST} {f}")
            print()
        
        if not any(findings.values()):
            print(f"  {C.GRN}✓ No security issues found{C.RST}\n")
        
        return 0
    
    # Check for root
    if not args.dry_run and os.geteuid() != 0:
        print(f"  {C.RED}[!] This script requires root privileges{C.RST}")
        print(f"  {C.DIM}Run with sudo or use --dry-run to preview{C.RST}\n")
        return 1
    
    if args.dry_run:
        print(f"  {C.YLW}[DRY RUN] No changes will be made{C.RST}\n")
    
    total_applied = 0
    total_failed = 0
    
    # Apply selected hardening
    if args.all or args.sysctl:
        print(f"  {C.BLD}Kernel Hardening (sysctl){C.RST}")
        print(f"  {C.DIM}{'─' * 55}{C.RST}")
        applied, failed = apply_sysctl(args.dry_run, args.verbose)
        print(f"  {C.GRN}Applied: {applied}{C.RST}")
        total_applied += applied
        total_failed += failed
        print()
    
    if args.all or args.ssh:
        print(f"  {C.BLD}SSH Hardening{C.RST}")
        print(f"  {C.DIM}{'─' * 55}{C.RST}")
        applied, failed = harden_ssh(args.dry_run, args.verbose)
        print(f"  {C.GRN}Applied: {applied}{C.RST}")
        total_applied += applied
        total_failed += failed
        print()
    
    if args.all or args.services:
        print(f"  {C.BLD}Disable Dangerous Services{C.RST}")
        print(f"  {C.DIM}{'─' * 55}{C.RST}")
        disabled, skipped = disable_services(args.dry_run, args.verbose)
        print(f"  {C.GRN}Disabled: {disabled}, Skipped: {skipped}{C.RST}")
        total_applied += disabled
        print()
    
    if args.all or args.permissions:
        print(f"  {C.BLD}File Permissions{C.RST}")
        print(f"  {C.DIM}{'─' * 55}{C.RST}")
        fixed, failed = set_permissions(args.dry_run, args.verbose)
        print(f"  {C.GRN}Fixed: {fixed}, Failed: {failed}{C.RST}")
        total_applied += fixed
        total_failed += failed
        print()
    
    if args.all or args.firewall:
        print(f"  {C.BLD}Firewall Configuration{C.RST}")
        print(f"  {C.DIM}{'─' * 55}{C.RST}")
        if setup_firewall(args.dry_run, args.verbose):
            print(f"  {C.GRN}Firewall configured{C.RST}")
            total_applied += 1
        print()
    
    # Summary
    if total_applied > 0 or total_failed > 0:
        print(f"  {C.BLD}Summary{C.RST}")
        print(f"  {C.DIM}{'─' * 55}{C.RST}")
        print(f"  {C.GRN}Total applied: {total_applied}{C.RST}")
        if total_failed:
            print(f"  {C.RED}Total failed: {total_failed}{C.RST}")
        print()
    
    if not any([args.all, args.sysctl, args.ssh, args.services, 
                args.permissions, args.firewall]):
        parser.print_help()
    
    return 0


if __name__ == '__main__':
    sys.exit(main())
