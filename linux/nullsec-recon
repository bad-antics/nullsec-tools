#!/bin/bash
# ============================================================================
# NullSec Recon - Network & System Reconnaissance Toolkit
# ============================================================================
# Passive and active information gathering
# Licensed under NullSec Public License v1.0
# ============================================================================

VERSION="1.0.0"
DATA_DIR="$HOME/.local/share/nullsec/recon"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

banner() {
    echo -e "${CYAN}"
    cat << 'EOF'
    ╔═══════════════════════════════════════════════════════════════╗
    ║          NULLSEC RECON v1.0                                   ║
    ║          Network & System Reconnaissance                      ║
    ╚═══════════════════════════════════════════════════════════════╝
EOF
    echo -e "${NC}"
}

log() { echo -e "${GREEN}[✓]${NC} $1"; }
warn() { echo -e "${YELLOW}[!]${NC} $1"; }
error() { echo -e "${RED}[✗]${NC} $1"; }
info() { echo -e "${BLUE}[i]${NC} $1"; }

init() { mkdir -p "$DATA_DIR"/{hosts,domains,reports}; }

# DNS reconnaissance
dns_recon() {
    local target="$1"
    [[ -z "$target" ]] && { error "Usage: dns <domain>"; return 1; }
    
    info "DNS Reconnaissance: $target"
    echo ""
    
    echo -e "${CYAN}=== A Records ===${NC}"
    dig +short A "$target" 2>/dev/null || host -t A "$target" 2>/dev/null
    
    echo -e "\n${CYAN}=== AAAA Records ===${NC}"
    dig +short AAAA "$target" 2>/dev/null || host -t AAAA "$target" 2>/dev/null
    
    echo -e "\n${CYAN}=== MX Records ===${NC}"
    dig +short MX "$target" 2>/dev/null || host -t MX "$target" 2>/dev/null
    
    echo -e "\n${CYAN}=== NS Records ===${NC}"
    dig +short NS "$target" 2>/dev/null || host -t NS "$target" 2>/dev/null
    
    echo -e "\n${CYAN}=== TXT Records ===${NC}"
    dig +short TXT "$target" 2>/dev/null || host -t TXT "$target" 2>/dev/null
    
    echo -e "\n${CYAN}=== SOA Record ===${NC}"
    dig +short SOA "$target" 2>/dev/null
    
    # Check for common subdomains
    echo -e "\n${CYAN}=== Common Subdomains ===${NC}"
    for sub in www mail ftp ssh vpn admin api dev staging test; do
        local ip=$(dig +short "$sub.$target" 2>/dev/null | head -1)
        [[ -n "$ip" ]] && echo "$sub.$target -> $ip"
    done
}

# WHOIS lookup
whois_lookup() {
    local target="$1"
    [[ -z "$target" ]] && { error "Usage: whois <domain>"; return 1; }
    
    info "WHOIS Lookup: $target"
    echo ""
    
    whois "$target" 2>/dev/null | grep -iE "registrar|creation|expir|name server|registrant|admin|tech" | head -30
}

# IP geolocation
geoip() {
    local ip="$1"
    [[ -z "$ip" ]] && { error "Usage: geoip <ip>"; return 1; }
    
    info "GeoIP Lookup: $ip"
    echo ""
    
    curl -s "http://ip-api.com/json/$ip" 2>/dev/null | \
    python3 -c "import sys,json; d=json.load(sys.stdin); print(f'''Country: {d.get('country','-')}
Region: {d.get('regionName','-')}
City: {d.get('city','-')}
ZIP: {d.get('zip','-')}
ISP: {d.get('isp','-')}
Org: {d.get('org','-')}
AS: {d.get('as','-')}
Lat/Lon: {d.get('lat','-')}, {d.get('lon','-')}''')" 2>/dev/null || \
    curl -s "https://ipinfo.io/$ip" 2>/dev/null
}

# Reverse DNS
reverse_dns() {
    local ip="$1"
    [[ -z "$ip" ]] && { error "Usage: reverse <ip>"; return 1; }
    
    info "Reverse DNS: $ip"
    dig +short -x "$ip" 2>/dev/null || host "$ip" 2>/dev/null
}

# Network scan (local)
net_scan() {
    local subnet="${1:-$(ip route | grep -v default | head -1 | awk '{print $1}')}"
    
    info "Scanning network: $subnet"
    echo ""
    
    if command -v nmap &>/dev/null; then
        nmap -sn "$subnet" 2>/dev/null | grep -E "Nmap scan|Host is up|MAC Address"
    else
        # Fallback ping sweep
        local base=$(echo "$subnet" | cut -d'/' -f1 | sed 's/\.[0-9]*$//')
        for i in $(seq 1 254); do
            ping -c 1 -W 1 "$base.$i" &>/dev/null && echo "$base.$i is up" &
        done
        wait
    fi
}

# HTTP headers
http_headers() {
    local url="$1"
    [[ -z "$url" ]] && { error "Usage: headers <url>"; return 1; }
    
    [[ "$url" != http* ]] && url="https://$url"
    
    info "HTTP Headers: $url"
    echo ""
    
    curl -sI -L --max-time 10 "$url" 2>/dev/null | head -50
}

# SSL certificate info
ssl_info() {
    local host="$1"
    local port="${2:-443}"
    [[ -z "$host" ]] && { error "Usage: ssl <host> [port]"; return 1; }
    
    info "SSL Certificate: $host:$port"
    echo ""
    
    echo | openssl s_client -connect "$host:$port" -servername "$host" 2>/dev/null | \
    openssl x509 -noout -text 2>/dev/null | \
    grep -E "Subject:|Issuer:|Not Before|Not After|DNS:" | head -20
}

# Port scan
port_scan() {
    local host="$1"
    local ports="${2:-21,22,23,25,53,80,110,143,443,445,993,995,3306,3389,5432,8080,8443}"
    
    [[ -z "$host" ]] && { error "Usage: ports <host> [ports]"; return 1; }
    
    info "Port Scan: $host"
    echo ""
    
    if command -v nmap &>/dev/null; then
        nmap -Pn -p "$ports" "$host" 2>/dev/null | grep -E "^[0-9]+/|Host is"
    else
        # Bash fallback
        for port in ${ports//,/ }; do
            (echo >/dev/tcp/"$host"/"$port") 2>/dev/null && echo -e "${GREEN}$port/tcp open${NC}" || echo -e "${RED}$port/tcp closed${NC}"
        done
    fi
}

# Traceroute
trace_route() {
    local host="$1"
    [[ -z "$host" ]] && { error "Usage: trace <host>"; return 1; }
    
    info "Traceroute: $host"
    echo ""
    
    traceroute -m 20 "$host" 2>/dev/null || tracepath "$host" 2>/dev/null
}

# Full target recon
full_recon() {
    local target="$1"
    local report="$DATA_DIR/reports/recon-$(echo "$target" | tr '/' '_')-$(date +%Y%m%d_%H%M%S).txt"
    
    [[ -z "$target" ]] && { error "Usage: full <domain/ip>"; return 1; }
    
    banner
    info "Full reconnaissance: $target"
    info "Report: $report"
    echo ""
    
    {
        echo "═══════════════════════════════════════════════════════════════"
        echo "NullSec Recon Report"
        echo "Target: $target"
        echo "Date: $(date)"
        echo "═══════════════════════════════════════════════════════════════"
        echo ""
        
        echo "=== DNS ==="
        dns_recon "$target" 2>&1
        echo ""
        
        echo "=== WHOIS ==="
        whois_lookup "$target" 2>&1
        echo ""
        
        echo "=== HTTP Headers ==="
        http_headers "$target" 2>&1
        echo ""
        
        echo "=== SSL Certificate ==="
        ssl_info "$target" 2>&1
        echo ""
        
        echo "=== Port Scan ==="
        port_scan "$target" 2>&1
        echo ""
        
    } | tee "$report"
    
    log "Report saved: $report"
}

# System recon
system_recon() {
    banner
    info "Local System Reconnaissance"
    echo ""
    
    echo -e "${CYAN}=== System Info ===${NC}"
    echo "Hostname: $(hostname)"
    echo "Kernel: $(uname -r)"
    echo "OS: $(cat /etc/os-release 2>/dev/null | grep PRETTY_NAME | cut -d'"' -f2)"
    echo "Arch: $(uname -m)"
    echo "Uptime: $(uptime -p 2>/dev/null || uptime)"
    
    echo -e "\n${CYAN}=== Network Interfaces ===${NC}"
    ip -br addr 2>/dev/null || ifconfig 2>/dev/null
    
    echo -e "\n${CYAN}=== Default Gateway ===${NC}"
    ip route | grep default
    
    echo -e "\n${CYAN}=== DNS Servers ===${NC}"
    cat /etc/resolv.conf | grep nameserver
    
    echo -e "\n${CYAN}=== Listening Services ===${NC}"
    ss -tlnp 2>/dev/null | head -20 || netstat -tlnp 2>/dev/null | head -20
    
    echo -e "\n${CYAN}=== Active Connections ===${NC}"
    ss -tnp 2>/dev/null | head -15 || netstat -tnp 2>/dev/null | head -15
    
    echo -e "\n${CYAN}=== Users ===${NC}"
    who 2>/dev/null
    
    echo -e "\n${CYAN}=== Last Logins ===${NC}"
    last -5 2>/dev/null
}

show_help() {
    banner
    cat << 'HELP'
USAGE:
    nullsec-recon <command> <target>

DNS & DOMAIN:
    dns <domain>        DNS record enumeration
    whois <domain>      WHOIS lookup
    reverse <ip>        Reverse DNS lookup

NETWORK:
    scan [subnet]       Network host discovery
    ports <host>        Port scan
    trace <host>        Traceroute

WEB:
    headers <url>       HTTP headers
    ssl <host>          SSL certificate info

IP:
    geoip <ip>          IP geolocation

COMPREHENSIVE:
    full <target>       Full target reconnaissance
    system              Local system recon

EXAMPLES:
    nullsec-recon dns example.com
    nullsec-recon ports 192.168.1.1
    nullsec-recon full example.com
    nullsec-recon system

LICENSE:
    NullSec Public License v1.0
HELP
}

main() {
    init
    case "${1:-help}" in
        dns) shift; dns_recon "$@" ;;
        whois) shift; whois_lookup "$@" ;;
        reverse|rdns) shift; reverse_dns "$@" ;;
        scan|netscan) shift; net_scan "$@" ;;
        ports|port) shift; port_scan "$@" ;;
        trace|traceroute) shift; trace_route "$@" ;;
        headers|http) shift; http_headers "$@" ;;
        ssl|cert) shift; ssl_info "$@" ;;
        geoip|geo) shift; geoip "$@" ;;
        full|recon) shift; full_recon "$@" ;;
        system|local) system_recon ;;
        *) show_help ;;
    esac
}

main "$@"
