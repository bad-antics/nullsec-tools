#!/bin/bash
# ============================================================================
# NullSec Audit - System Security Auditing Tool
# ============================================================================
# Comprehensive security audit and compliance checking
# Licensed under NullSec Public License v1.0
# ============================================================================

VERSION="1.0.0"
REPORT_DIR="$HOME/.local/share/nullsec/audits"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
PURPLE='\033[0;35m'
NC='\033[0m'

banner() {
    echo -e "${RED}"
    cat << 'EOF'
    ╔═══════════════════════════════════════════════════════════════╗
    ║          NULLSEC AUDIT v1.0                                   ║
    ║          Security Auditing System                             ║
    ╚═══════════════════════════════════════════════════════════════╝
EOF
    echo -e "${NC}"
}

log() { echo -e "${GREEN}[PASS]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
fail() { echo -e "${RED}[FAIL]${NC} $1"; }
info() { echo -e "${BLUE}[INFO]${NC} $1"; }

init() { mkdir -p "$REPORT_DIR"; }

# Password policy audit
audit_passwords() {
    echo -e "${CYAN}═══ Password Policy Audit ═══${NC}"
    echo ""
    
    local score=0
    local total=5
    
    # Check password aging
    if grep -q "^PASS_MAX_DAYS.*90" /etc/login.defs 2>/dev/null; then
        log "Password max age configured (90 days)"
        ((score++))
    else
        warn "Password max age not optimally configured"
    fi
    
    # Check minimum password length
    if grep -qE "minlen\s*=\s*[8-9]|minlen\s*=\s*[1-9][0-9]" /etc/security/pwquality.conf 2>/dev/null; then
        log "Minimum password length >= 8"
        ((score++))
    else
        warn "Minimum password length should be >= 8"
    fi
    
    # Check for empty passwords
    local empty_pass=$(awk -F: '($2 == "") {print $1}' /etc/shadow 2>/dev/null)
    if [[ -z "$empty_pass" ]]; then
        log "No accounts with empty passwords"
        ((score++))
    else
        fail "Accounts with empty passwords: $empty_pass"
    fi
    
    # Check root password
    if [[ $(grep "^root:" /etc/shadow 2>/dev/null | cut -d: -f2) != "!" ]] && \
       [[ $(grep "^root:" /etc/shadow 2>/dev/null | cut -d: -f2) != "*" ]]; then
        log "Root account has password set"
        ((score++))
    else
        warn "Root account password status unclear"
    fi
    
    # PAM configuration
    if grep -q "pam_pwquality.so" /etc/pam.d/common-password 2>/dev/null; then
        log "PAM password quality module enabled"
        ((score++))
    else
        warn "PAM password quality module not configured"
    fi
    
    echo ""
    echo "Password Policy Score: $score/$total"
}

# SSH audit
audit_ssh() {
    echo -e "${CYAN}═══ SSH Security Audit ═══${NC}"
    echo ""
    
    local score=0
    local total=8
    local ssh_config="/etc/ssh/sshd_config"
    
    [[ ! -f "$ssh_config" ]] && { warn "SSH config not found"; return; }
    
    # Root login
    if grep -qE "^PermitRootLogin\s+no" "$ssh_config" 2>/dev/null; then
        log "Root login disabled"
        ((score++))
    else
        fail "Root login should be disabled"
    fi
    
    # Password authentication
    if grep -qE "^PasswordAuthentication\s+no" "$ssh_config" 2>/dev/null; then
        log "Password authentication disabled (key-only)"
        ((score++))
    else
        warn "Password authentication enabled"
    fi
    
    # Protocol version
    if ! grep -qE "^Protocol\s+1" "$ssh_config" 2>/dev/null; then
        log "SSH Protocol 1 disabled"
        ((score++))
    else
        fail "SSH Protocol 1 should be disabled"
    fi
    
    # X11 forwarding
    if grep -qE "^X11Forwarding\s+no" "$ssh_config" 2>/dev/null; then
        log "X11 forwarding disabled"
        ((score++))
    else
        warn "X11 forwarding enabled"
    fi
    
    # Empty passwords
    if grep -qE "^PermitEmptyPasswords\s+no" "$ssh_config" 2>/dev/null; then
        log "Empty passwords denied"
        ((score++))
    else
        fail "Empty passwords should be denied"
    fi
    
    # Max auth tries
    if grep -qE "^MaxAuthTries\s+[1-4]" "$ssh_config" 2>/dev/null; then
        log "Max auth tries limited"
        ((score++))
    else
        warn "Max auth tries should be limited"
    fi
    
    # Idle timeout
    if grep -qE "^ClientAliveInterval\s+[0-9]+" "$ssh_config" 2>/dev/null; then
        log "Client alive interval configured"
        ((score++))
    else
        warn "Client alive interval not set"
    fi
    
    # Strong ciphers
    if grep -qE "^Ciphers\s+.*aes256" "$ssh_config" 2>/dev/null; then
        log "Strong ciphers configured"
        ((score++))
    else
        info "Consider configuring strong ciphers"
    fi
    
    echo ""
    echo "SSH Security Score: $score/$total"
}

# Firewall audit
audit_firewall() {
    echo -e "${CYAN}═══ Firewall Audit ═══${NC}"
    echo ""
    
    local score=0
    local total=4
    
    # Check if firewall is active
    if command -v ufw &>/dev/null && ufw status | grep -q "active"; then
        log "UFW firewall is active"
        ((score++))
    elif command -v firewall-cmd &>/dev/null && firewall-cmd --state 2>/dev/null | grep -q "running"; then
        log "FirewallD is active"
        ((score++))
    elif iptables -L -n 2>/dev/null | grep -q "DROP\|REJECT"; then
        log "iptables has blocking rules"
        ((score++))
    else
        fail "No active firewall detected"
    fi
    
    # Check default policy
    if iptables -L INPUT -n 2>/dev/null | head -1 | grep -q "DROP"; then
        log "Default INPUT policy is DROP"
        ((score++))
    else
        warn "Default INPUT policy should be DROP"
    fi
    
    # Check for open ports
    local open_ports=$(ss -tlnp 2>/dev/null | grep -c "LISTEN" || echo "0")
    if [[ $open_ports -lt 10 ]]; then
        log "Limited open ports: $open_ports"
        ((score++))
    else
        warn "Many open ports: $open_ports"
    fi
    
    # IPv6 status
    if [[ $(cat /proc/sys/net/ipv6/conf/all/disable_ipv6 2>/dev/null) == "1" ]]; then
        log "IPv6 disabled"
        ((score++))
    else
        info "IPv6 enabled (disable if not needed)"
    fi
    
    echo ""
    echo "Firewall Score: $score/$total"
}

# File permissions audit
audit_permissions() {
    echo -e "${CYAN}═══ File Permissions Audit ═══${NC}"
    echo ""
    
    local score=0
    local total=6
    
    # /etc/passwd permissions
    if [[ $(stat -c%a /etc/passwd 2>/dev/null) == "644" ]]; then
        log "/etc/passwd permissions correct (644)"
        ((score++))
    else
        fail "/etc/passwd should be 644"
    fi
    
    # /etc/shadow permissions
    if [[ $(stat -c%a /etc/shadow 2>/dev/null) =~ ^(0|400|600)$ ]]; then
        log "/etc/shadow permissions restricted"
        ((score++))
    else
        fail "/etc/shadow should be 000 or 600"
    fi
    
    # SSH directory
    if [[ -d "$HOME/.ssh" ]]; then
        if [[ $(stat -c%a "$HOME/.ssh" 2>/dev/null) == "700" ]]; then
            log "~/.ssh directory permissions correct (700)"
            ((score++))
        else
            warn "~/.ssh should be 700"
        fi
    else
        info "No ~/.ssh directory"
        ((score++))
    fi
    
    # World-writable files
    local world_writable=$(find /etc /usr -type f -perm -002 2>/dev/null | wc -l)
    if [[ $world_writable -eq 0 ]]; then
        log "No world-writable system files"
        ((score++))
    else
        warn "Found $world_writable world-writable files"
    fi
    
    # SUID binaries
    local suid_count=$(find /usr -type f -perm -4000 2>/dev/null | wc -l)
    if [[ $suid_count -lt 30 ]]; then
        log "SUID binaries: $suid_count (reasonable)"
        ((score++))
    else
        warn "Many SUID binaries: $suid_count"
    fi
    
    # /tmp permissions
    if mount | grep -q "/tmp.*noexec"; then
        log "/tmp mounted with noexec"
        ((score++))
    else
        info "/tmp should be mounted with noexec"
    fi
    
    echo ""
    echo "Permissions Score: $score/$total"
}

# Services audit
audit_services() {
    echo -e "${CYAN}═══ Services Audit ═══${NC}"
    echo ""
    
    local score=0
    local total=5
    
    # Unnecessary services
    local dangerous_services="telnet rsh rlogin rexec tftp"
    local found_dangerous=0
    
    for svc in $dangerous_services; do
        if systemctl is-active "$svc" &>/dev/null || \
           pgrep -x "$svc" &>/dev/null; then
            fail "Dangerous service running: $svc"
            ((found_dangerous++))
        fi
    done
    
    if [[ $found_dangerous -eq 0 ]]; then
        log "No dangerous legacy services running"
        ((score++))
    fi
    
    # Check for automatic updates
    if systemctl is-enabled unattended-upgrades &>/dev/null || \
       systemctl is-enabled dnf-automatic &>/dev/null; then
        log "Automatic updates enabled"
        ((score++))
    else
        warn "Automatic updates not configured"
    fi
    
    # NTP sync
    if timedatectl status 2>/dev/null | grep -q "synchronized: yes"; then
        log "Time synchronized via NTP"
        ((score++))
    else
        warn "Time synchronization not verified"
    fi
    
    # Cron permissions
    if [[ -f /etc/cron.allow ]] || [[ ! -r /etc/cron.deny ]]; then
        log "Cron access restricted"
        ((score++))
    else
        warn "Cron access should be restricted"
    fi
    
    # Running services count
    local running=$(systemctl list-units --type=service --state=running 2>/dev/null | grep -c "running")
    if [[ $running -lt 50 ]]; then
        log "Reasonable number of services: $running"
        ((score++))
    else
        warn "Many running services: $running"
    fi
    
    echo ""
    echo "Services Score: $score/$total"
}

# Kernel security audit
audit_kernel() {
    echo -e "${CYAN}═══ Kernel Security Audit ═══${NC}"
    echo ""
    
    local score=0
    local total=6
    
    # ASLR
    if [[ $(cat /proc/sys/kernel/randomize_va_space 2>/dev/null) == "2" ]]; then
        log "ASLR fully enabled"
        ((score++))
    else
        fail "ASLR should be set to 2"
    fi
    
    # Exec-shield / NX
    if grep -q "nx" /proc/cpuinfo 2>/dev/null; then
        log "NX/XD bit supported"
        ((score++))
    else
        info "NX/XD support not detected"
    fi
    
    # Core dumps restricted
    if [[ $(cat /proc/sys/fs/suid_dumpable 2>/dev/null) == "0" ]]; then
        log "SUID core dumps disabled"
        ((score++))
    else
        warn "SUID core dumps should be disabled"
    fi
    
    # Kernel pointer hiding
    if [[ $(cat /proc/sys/kernel/kptr_restrict 2>/dev/null) -ge 1 ]]; then
        log "Kernel pointers restricted"
        ((score++))
    else
        warn "Kernel pointers should be restricted"
    fi
    
    # SYN cookies
    if [[ $(cat /proc/sys/net/ipv4/tcp_syncookies 2>/dev/null) == "1" ]]; then
        log "SYN cookies enabled"
        ((score++))
    else
        warn "SYN cookies should be enabled"
    fi
    
    # IP forwarding
    if [[ $(cat /proc/sys/net/ipv4/ip_forward 2>/dev/null) == "0" ]]; then
        log "IP forwarding disabled"
        ((score++))
    else
        warn "IP forwarding enabled (disable if not needed)"
    fi
    
    echo ""
    echo "Kernel Security Score: $score/$total"
}

# Full audit
full_audit() {
    local report="$REPORT_DIR/audit-$(date +%Y%m%d_%H%M%S).txt"
    
    banner
    info "Running full security audit..."
    info "Report: $report"
    echo ""
    
    {
        echo "═══════════════════════════════════════════════════════════════"
        echo "NullSec Security Audit Report"
        echo "Date: $(date)"
        echo "Hostname: $(hostname)"
        echo "═══════════════════════════════════════════════════════════════"
        echo ""
        
        audit_passwords
        echo ""
        audit_ssh
        echo ""
        audit_firewall
        echo ""
        audit_permissions
        echo ""
        audit_services
        echo ""
        audit_kernel
        echo ""
        
    } | tee "$report"
    
    echo "═══════════════════════════════════════════════════════════════"
    log "Audit complete! Report saved: $report"
}

show_help() {
    banner
    cat << 'HELP'
USAGE:
    nullsec-audit <command>

AUDIT COMMANDS:
    full                Complete security audit
    passwords           Password policy audit
    ssh                 SSH configuration audit
    firewall            Firewall audit
    permissions         File permissions audit
    services            Services audit
    kernel              Kernel security audit

EXAMPLES:
    nullsec-audit full
    nullsec-audit ssh
    nullsec-audit permissions

REPORTS:
    ~/.local/share/nullsec/audits/

LICENSE:
    NullSec Public License v1.0
HELP
}

main() {
    init
    case "${1:-help}" in
        full|all) full_audit ;;
        passwords|pass) banner; audit_passwords ;;
        ssh) banner; audit_ssh ;;
        firewall|fw) banner; audit_firewall ;;
        permissions|perms) banner; audit_permissions ;;
        services|svc) banner; audit_services ;;
        kernel) banner; audit_kernel ;;
        *) show_help ;;
    esac
}

main "$@"
