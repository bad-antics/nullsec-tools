#!/bin/bash
# ============================================================================
# NullSec Evade - Anti-Detection & Evasion Toolkit
# ============================================================================
# Techniques to avoid detection during red team operations
# Licensed under NullSec Public License v1.0
# ============================================================================

VERSION="1.0.0"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

info() { echo -e "${CYAN}[*]${NC} $1"; }
success() { echo -e "${GREEN}[✓]${NC} $1"; }
warn() { echo -e "${YELLOW}[!]${NC} $1"; }
error() { echo -e "${RED}[✗]${NC} $1"; }

# Clear bash history
clear_history() {
    info "Clearing shell history..."
    history -c && history -w
    > ~/.bash_history 2>/dev/null
    > ~/.zsh_history 2>/dev/null
    unset HISTFILE
    export HISTSIZE=0
    success "History cleared"
}

# Timestomp file
timestomp() {
    local file="$1"
    local reference="${2:-/etc/passwd}"
    [[ ! -f "$file" ]] && { error "File required"; return 1; }
    
    if [[ -f "$reference" ]]; then
        touch -r "$reference" "$file"
        success "Timestamps matched to: $reference"
    else
        touch -t 197001010000 "$file"
        success "Timestamps set to epoch"
    fi
    stat "$file"
}

# Check detection tools
check_detection() {
    echo -e "\n${CYAN}Detection Check:${NC}\n"
    
    for av in clamav rkhunter chkrootkit; do
        if command -v "$av" &>/dev/null; then
            echo -e "  ${RED}●${NC} $av installed"
        fi
    done
    
    for edr in auditd osqueryd falcon-sensor; do
        if pgrep -x "$edr" &>/dev/null; then
            echo -e "  ${RED}●${NC} $edr running"
        fi
    done
}

# Hide file
hide_file() {
    local file="$1"
    [[ ! -f "$file" ]] && { error "File required"; return 1; }
    
    local dir=$(dirname "$file")
    local name=$(basename "$file")
    mv "$file" "$dir/.$name"
    success "Hidden: .$name"
}

show_help() {
    cat << 'HELP'
NullSec Evade - Anti-Detection Toolkit

USAGE:
    nullsec-evade <command> [options]

COMMANDS:
    history                        Clear shell history
    timestomp <file> [reference]   Modify file timestamps
    detect                         Check for detection tools
    hide <file>                    Hide file (add dot prefix)

LICENSE:
    NullSec Public License v1.0
HELP
}

case "$1" in
    -h|--help|help|"") show_help ;;
    history) clear_history ;;
    timestomp|ts) shift; timestomp "$@" ;;
    detect|check) check_detection ;;
    hide) shift; hide_file "$@" ;;
    *) error "Unknown: $1"; show_help; exit 1 ;;
esac
