#!/bin/bash
# ============================================================================
# NullSec DFIR - Digital Forensics & Incident Response
# ============================================================================
# Memory analysis, disk forensics, and evidence collection
# Licensed under NullSec Public License v1.0
# ============================================================================

VERSION="1.0.0"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'

DFIR_DIR="$HOME/.local/share/nullsec/dfir"
EVIDENCE_DIR="$DFIR_DIR/evidence"
TIMELINE_DIR="$DFIR_DIR/timelines"
mkdir -p "$EVIDENCE_DIR" "$TIMELINE_DIR"

info() { echo -e "${CYAN}[*]${NC} $1"; }
success() { echo -e "${GREEN}[✓]${NC} $1"; }
warn() { echo -e "${YELLOW}[!]${NC} $1"; }
error() { echo -e "${RED}[✗]${NC} $1"; }

# Acquire disk image
acquire_disk() {
    local source="$1"
    local dest="${2:-$EVIDENCE_DIR/disk-$(date +%Y%m%d%H%M%S).img}"
    local method="${3:-dd}"
    
    [[ -z "$source" ]] && { error "Source device required"; return 1; }
    
    info "Acquiring disk image: $source"
    echo "  Destination: $dest"
    echo "  Method: $method"
    
    case "$method" in
        dd)
            sudo dd if="$source" of="$dest" bs=64K conv=noerror,sync status=progress
            ;;
        dcfldd)
            if command -v dcfldd &>/dev/null; then
                sudo dcfldd if="$source" of="$dest" bs=64K hash=md5,sha256 hashlog="$dest.hash"
            else
                warn "dcfldd not found, using dd"
                sudo dd if="$source" of="$dest" bs=64K conv=noerror,sync status=progress
            fi
            ;;
        ewf)
            if command -v ewfacquire &>/dev/null; then
                sudo ewfacquire "$source" -t "${dest%.img}" -f encase6
            else
                error "ewfacquire not installed"
                return 1
            fi
            ;;
    esac
    
    # Generate hash
    info "Generating hashes..."
    md5sum "$dest" | tee "$dest.md5"
    sha256sum "$dest" | tee "$dest.sha256"
    
    success "Acquisition complete: $dest"
}

# Memory dump
memory_dump() {
    local output="${1:-$EVIDENCE_DIR/memory-$(date +%Y%m%d%H%M%S).raw}"
    
    info "Acquiring memory dump..."
    
    if [[ -r /dev/mem ]]; then
        sudo dd if=/dev/mem of="$output" bs=1M status=progress 2>/dev/null
    elif [[ -r /proc/kcore ]]; then
        sudo dd if=/proc/kcore of="$output" bs=1M status=progress 2>/dev/null
    elif command -v avml &>/dev/null; then
        sudo avml "$output"
    else
        error "No memory acquisition method available"
        return 1
    fi
    
    success "Memory dump: $output"
}

# Volatile data collection
collect_volatile() {
    local output_dir="$EVIDENCE_DIR/volatile-$(date +%Y%m%d%H%M%S)"
    mkdir -p "$output_dir"
    
    info "Collecting volatile data..."
    
    # System info
    {
        echo "=== Date/Time ===" && date
        echo -e "\n=== Uptime ===" && uptime
        echo -e "\n=== Kernel ===" && uname -a
    } > "$output_dir/system.txt"
    
    # Network
    {
        echo "=== Network Interfaces ===" && ip addr
        echo -e "\n=== Routing ===" && ip route
        echo -e "\n=== ARP ===" && ip neigh
        echo -e "\n=== Connections ===" && ss -tulpn
    } > "$output_dir/network.txt"
    
    # Processes
    {
        echo "=== Processes ===" && ps auxf
        echo -e "\n=== Open Files ===" && lsof 2>/dev/null | head -200
    } > "$output_dir/processes.txt"
    
    # Users
    {
        echo "=== Logged In ===" && who
        echo -e "\n=== Last Logins ===" && last | head -50
    } > "$output_dir/users.txt"
    
    success "Volatile data collected: $output_dir"
}

# File timeline
create_timeline() {
    local target="${1:-.}"
    local output="$TIMELINE_DIR/timeline-$(date +%Y%m%d%H%M%S).csv"
    
    info "Creating file timeline for: $target"
    
    echo "Modified,Accessed,Changed,Permissions,User,Size,Path" > "$output"
    find "$target" -type f 2>/dev/null | while read -r file; do
        stat --printf='%y,%x,%z,%A,%U,%s,%n\n' "$file" 2>/dev/null
    done >> "$output"
    
    success "Timeline created: $output"
}

# Hash evidence
hash_evidence() {
    local target="${1:-.}"
    local output="$EVIDENCE_DIR/hashes-$(date +%Y%m%d%H%M%S).txt"
    
    info "Hashing files in: $target"
    find "$target" -type f 2>/dev/null | while read -r file; do
        sha256sum "$file" 2>/dev/null
    done | tee "$output"
    
    success "Hashes saved: $output"
}

# Generate report
generate_report() {
    local case_name="${1:-investigation}"
    local report="$EVIDENCE_DIR/${case_name}-report-$(date +%Y%m%d).md"
    
    cat > "$report" << EOF
# DFIR Report: $case_name
**Date:** $(date)
**System:** $(uname -a)

## Evidence Collected
$(ls -la "$EVIDENCE_DIR" 2>/dev/null)

## Notes
[Add notes here]

---
Generated by NullSec DFIR v$VERSION
EOF
    success "Report generated: $report"
}

show_help() {
    cat << 'HELP'
NullSec DFIR - Digital Forensics & Incident Response

USAGE:
    nullsec-dfir <command> [options]

COMMANDS:
    acquire <device> [output] [method]   Acquire disk image
    memory [output]                      Dump system memory
    volatile                             Collect volatile data
    timeline <path>                      Create file timeline
    hash <path>                          Hash evidence files
    report <case_name>                   Generate report

LICENSE:
    NullSec Public License v1.0
HELP
}

case "$1" in
    -h|--help|help|"") show_help ;;
    acquire|disk) shift; acquire_disk "$@" ;;
    memory|mem) shift; memory_dump "$@" ;;
    volatile|live) collect_volatile ;;
    timeline|tl) shift; create_timeline "$@" ;;
    hash) shift; hash_evidence "$@" ;;
    report) shift; generate_report "$@" ;;
    *) error "Unknown: $1"; show_help; exit 1 ;;
esac
