#!/bin/bash
# ============================================================================
# NullSec Stealth - Anti-Detection & Privacy Suite
# ============================================================================
# MAC spoofing, DNS privacy, traffic obfuscation
# Licensed under NullSec Public License v1.0
# ============================================================================

set -e

VERSION="1.0.0"
CONFIG_DIR="$HOME/.config/nullsec-stealth"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
PURPLE='\033[0;35m'
NC='\033[0m'

banner() {
    echo -e "${PURPLE}"
    cat << 'EOF'
    ╔═══════════════════════════════════════════════════════════════╗
    ║            NULLSEC STEALTH v1.0                               ║
    ║            Anti-Detection & Privacy Suite                     ║
    ╚═══════════════════════════════════════════════════════════════╝
EOF
    echo -e "${NC}"
}

log() { echo -e "${GREEN}[✓]${NC} $1"; }
warn() { echo -e "${YELLOW}[!]${NC} $1"; }
error() { echo -e "${RED}[✗]${NC} $1"; exit 1; }
info() { echo -e "${BLUE}[i]${NC} $1"; }

init() {
    mkdir -p "$CONFIG_DIR"
}

# Generate random MAC address
generate_mac() {
    # Use locally administered addresses (second hex digit is 2, 6, A, or E)
    printf '%02x:%02x:%02x:%02x:%02x:%02x\n' \
        $((0x02 | (RANDOM & 0xFC))) \
        $((RANDOM % 256)) \
        $((RANDOM % 256)) \
        $((RANDOM % 256)) \
        $((RANDOM % 256)) \
        $((RANDOM % 256))
}

# Get vendor-specific MAC prefix
vendor_mac() {
    local vendor="${1:-random}"
    
    declare -A vendors=(
        ["apple"]="00:1C:B3"
        ["samsung"]="00:12:47"
        ["dell"]="00:14:22"
        ["intel"]="00:1E:67"
        ["cisco"]="00:00:0C"
        ["hp"]="00:1A:4B"
        ["lenovo"]="00:06:1B"
        ["asus"]="00:0C:6E"
        ["microsoft"]="00:03:FF"
        ["google"]="54:60:09"
    )
    
    if [[ "$vendor" == "random" ]]; then
        local keys=(${!vendors[@]})
        vendor="${keys[RANDOM % ${#keys[@]}]}"
    fi
    
    if [[ -n "${vendors[$vendor]}" ]]; then
        printf '%s:%02x:%02x:%02x\n' \
            "${vendors[$vendor]}" \
            $((RANDOM % 256)) \
            $((RANDOM % 256)) \
            $((RANDOM % 256))
    else
        generate_mac
    fi
}

# Spoof MAC address
spoof_mac() {
    local interface="$1"
    local new_mac="${2:-$(generate_mac)}"
    
    [[ -z "$interface" ]] && error "Usage: spoof-mac <interface> [mac]"
    
    # Save original MAC
    local orig_mac
    orig_mac=$(ip link show "$interface" | grep -oP 'link/ether \K[0-9a-f:]+')
    echo "$orig_mac" > "$CONFIG_DIR/original_mac_$interface"
    
    info "Interface: $interface"
    info "Original MAC: $orig_mac"
    info "New MAC: $new_mac"
    
    # Bring down interface
    sudo ip link set "$interface" down
    
    # Change MAC
    sudo ip link set "$interface" address "$new_mac"
    
    # Bring up interface
    sudo ip link set "$interface" up
    
    log "MAC address spoofed successfully"
}

# Restore original MAC
restore_mac() {
    local interface="$1"
    
    [[ -z "$interface" ]] && error "Usage: restore-mac <interface>"
    
    local orig_file="$CONFIG_DIR/original_mac_$interface"
    [[ ! -f "$orig_file" ]] && error "No original MAC saved for $interface"
    
    local orig_mac
    orig_mac=$(cat "$orig_file")
    
    info "Restoring original MAC: $orig_mac"
    
    sudo ip link set "$interface" down
    sudo ip link set "$interface" address "$orig_mac"
    sudo ip link set "$interface" up
    
    rm -f "$orig_file"
    log "Original MAC restored"
}

# Configure DNS over HTTPS
setup_doh() {
    local provider="${1:-cloudflare}"
    
    declare -A providers=(
        ["cloudflare"]="https://cloudflare-dns.com/dns-query"
        ["google"]="https://dns.google/dns-query"
        ["quad9"]="https://dns.quad9.net/dns-query"
        ["adguard"]="https://dns.adguard-dns.com/dns-query"
    )
    
    local doh_url="${providers[$provider]}"
    [[ -z "$doh_url" ]] && error "Unknown provider: $provider"
    
    info "Configuring DNS over HTTPS ($provider)"
    
    # Create systemd-resolved config
    sudo mkdir -p /etc/systemd/resolved.conf.d
    cat << EOF | sudo tee /etc/systemd/resolved.conf.d/nullsec-doh.conf
[Resolve]
DNS=1.1.1.1#cloudflare-dns.com 1.0.0.1#cloudflare-dns.com
FallbackDNS=9.9.9.9#dns.quad9.net 149.112.112.112#dns.quad9.net
DNSOverTLS=yes
DNSSEC=yes
EOF
    
    sudo systemctl restart systemd-resolved
    log "DNS over HTTPS configured"
}

# Clear all traces
clear_traces() {
    info "Clearing system traces..."
    
    # Clear bash history
    history -c
    cat /dev/null > ~/.bash_history
    
    # Clear zsh history
    [[ -f ~/.zsh_history ]] && cat /dev/null > ~/.zsh_history
    
    # Clear recent files
    rm -rf ~/.local/share/recently-used.xbel 2>/dev/null
    
    # Clear thumbnails
    rm -rf ~/.cache/thumbnails/* 2>/dev/null
    
    # Clear clipboard
    if command -v xclip &>/dev/null; then
        echo -n | xclip -selection clipboard
    fi
    
    # Clear vim history
    rm -f ~/.viminfo
    
    # Clear less history
    rm -f ~/.lesshst
    
    # Clear wget history
    rm -f ~/.wget-hsts
    
    log "User traces cleared"
    
    # System traces (requires root)
    if [[ $EUID -eq 0 ]]; then
        # Clear auth log
        cat /dev/null > /var/log/auth.log 2>/dev/null || true
        cat /dev/null > /var/log/wtmp 2>/dev/null || true
        cat /dev/null > /var/log/btmp 2>/dev/null || true
        cat /dev/null > /var/log/lastlog 2>/dev/null || true
        log "System traces cleared"
    else
        warn "Run as root to clear system logs"
    fi
}

# Hostname randomizer
random_hostname() {
    local prefix="${1:-nullsec}"
    local new_hostname="${prefix}-$(head /dev/urandom | tr -dc 'a-z0-9' | head -c 8)"
    
    info "New hostname: $new_hostname"
    
    # Save original
    hostname > "$CONFIG_DIR/original_hostname"
    
    sudo hostnamectl set-hostname "$new_hostname"
    log "Hostname changed"
}

# Restore hostname
restore_hostname() {
    local orig_file="$CONFIG_DIR/original_hostname"
    [[ ! -f "$orig_file" ]] && error "No original hostname saved"
    
    local orig_hostname
    orig_hostname=$(cat "$orig_file")
    
    info "Restoring hostname: $orig_hostname"
    sudo hostnamectl set-hostname "$orig_hostname"
    rm -f "$orig_file"
    log "Original hostname restored"
}

# Timezone hopping
change_timezone() {
    local zone="${1:-random}"
    
    if [[ "$zone" == "random" ]]; then
        local zones=(
            "America/New_York"
            "Europe/London"
            "Asia/Tokyo"
            "Australia/Sydney"
            "Europe/Paris"
            "America/Los_Angeles"
            "Asia/Singapore"
            "Europe/Berlin"
        )
        zone="${zones[RANDOM % ${#zones[@]}]}"
    fi
    
    # Save original
    timedatectl show -p Timezone --value > "$CONFIG_DIR/original_timezone"
    
    info "Changing timezone to: $zone"
    sudo timedatectl set-timezone "$zone"
    log "Timezone changed"
}

# Full stealth mode
stealth_mode() {
    local interface="${1:-$(ip route | grep default | awk '{print $5}' | head -1)}"
    
    banner
    info "Activating full stealth mode..."
    echo ""
    
    # Spoof MAC with random vendor
    log "Spoofing MAC address..."
    spoof_mac "$interface" "$(vendor_mac random)"
    echo ""
    
    # Change hostname
    log "Randomizing hostname..."
    random_hostname
    echo ""
    
    # Clear traces
    log "Clearing traces..."
    clear_traces
    echo ""
    
    # Configure DoH
    log "Setting up DNS over HTTPS..."
    setup_doh cloudflare
    echo ""
    
    echo -e "${GREEN}════════════════════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}         STEALTH MODE ACTIVATED                                  ${NC}"
    echo -e "${GREEN}════════════════════════════════════════════════════════════════${NC}"
    echo ""
    info "Interface: $interface"
    info "MAC: $(ip link show "$interface" | grep -oP 'link/ether \K[0-9a-f:]+')"
    info "Hostname: $(hostname)"
    info "DNS: Encrypted (DoH)"
}

# Restore all
restore_all() {
    banner
    info "Restoring original settings..."
    echo ""
    
    local interface
    interface=$(ip route | grep default | awk '{print $5}' | head -1)
    
    [[ -f "$CONFIG_DIR/original_mac_$interface" ]] && restore_mac "$interface"
    [[ -f "$CONFIG_DIR/original_hostname" ]] && restore_hostname
    [[ -f "$CONFIG_DIR/original_timezone" ]] && {
        sudo timedatectl set-timezone "$(cat "$CONFIG_DIR/original_timezone")"
        rm -f "$CONFIG_DIR/original_timezone"
        log "Timezone restored"
    }
    
    log "All settings restored"
}

# Status check
status() {
    banner
    
    local interface
    interface=$(ip route | grep default | awk '{print $5}' | head -1)
    
    echo -e "${CYAN}=== Current Status ===${NC}"
    echo ""
    echo "Interface:  $interface"
    echo "MAC:        $(ip link show "$interface" 2>/dev/null | grep -oP 'link/ether \K[0-9a-f:]+')"
    echo "Hostname:   $(hostname)"
    echo "Timezone:   $(timedatectl show -p Timezone --value)"
    echo "DNS:        $(cat /etc/resolv.conf | grep nameserver | head -1 | awk '{print $2}')"
    echo ""
    
    # Check saved originals
    if [[ -f "$CONFIG_DIR/original_mac_$interface" ]] || \
       [[ -f "$CONFIG_DIR/original_hostname" ]] || \
       [[ -f "$CONFIG_DIR/original_timezone" ]]; then
        echo -e "${YELLOW}=== Saved Originals ===${NC}"
        [[ -f "$CONFIG_DIR/original_mac_$interface" ]] && \
            echo "Original MAC: $(cat "$CONFIG_DIR/original_mac_$interface")"
        [[ -f "$CONFIG_DIR/original_hostname" ]] && \
            echo "Original Hostname: $(cat "$CONFIG_DIR/original_hostname")"
        [[ -f "$CONFIG_DIR/original_timezone" ]] && \
            echo "Original Timezone: $(cat "$CONFIG_DIR/original_timezone")"
    fi
}

# Help
show_help() {
    banner
    cat << 'HELP'
USAGE:
    nullsec-stealth <command> [options]

MAC COMMANDS:
    spoof-mac <iface> [mac]   Spoof MAC address (random if not specified)
    vendor-mac <vendor>       Generate vendor-specific MAC
    restore-mac <iface>       Restore original MAC

PRIVACY COMMANDS:
    doh [provider]            Setup DNS over HTTPS (cloudflare/google/quad9)
    clear                     Clear all traces (history, cache, logs)
    hostname [prefix]         Randomize hostname
    restore-hostname          Restore original hostname
    timezone [zone]           Change timezone (random if not specified)

FULL MODES:
    stealth [iface]           Activate full stealth mode
    restore                   Restore all original settings
    status                    Show current status

VENDORS:
    apple, samsung, dell, intel, cisco, hp, lenovo, asus, microsoft, google

EXAMPLES:
    sudo nullsec-stealth spoof-mac eth0
    sudo nullsec-stealth vendor-mac apple
    sudo nullsec-stealth stealth
    nullsec-stealth clear
    nullsec-stealth status

LICENSE:
    NullSec Public License v1.0

HELP
}

# Main
main() {
    init
    
    case "${1:-help}" in
        spoof-mac)
            banner
            spoof_mac "$2" "$3"
            ;;
        vendor-mac)
            vendor_mac "$2"
            ;;
        restore-mac)
            banner
            restore_mac "$2"
            ;;
        doh)
            banner
            setup_doh "$2"
            ;;
        clear)
            banner
            clear_traces
            ;;
        hostname)
            banner
            random_hostname "$2"
            ;;
        restore-hostname)
            banner
            restore_hostname
            ;;
        timezone)
            banner
            change_timezone "$2"
            ;;
        stealth)
            stealth_mode "$2"
            ;;
        restore)
            restore_all
            ;;
        status)
            status
            ;;
        *)
            show_help
            ;;
    esac
}

main "$@"
