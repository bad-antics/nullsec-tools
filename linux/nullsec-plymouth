#!/usr/bin/env python3
"""
NullSec Plymouth Manager - Boot Animation Control
=================================================
Manage multiple boot animations with random selection support.

(c) bad-antics development
"""

import os
import sys
import subprocess
import random
import shutil
from pathlib import Path

# ============================================================================
# Colors
# ============================================================================

class C:
    RST = '\033[0m'
    BLD = '\033[1m'
    DIM = '\033[2m'
    RED = '\033[0;31m'
    GRN = '\033[0;32m'
    YLW = '\033[0;33m'
    CYN = '\033[0;36m'
    MAG = '\033[0;35m'

# ============================================================================
# Configuration
# ============================================================================

PLYMOUTH_DIR = Path('/usr/share/plymouth/themes')
NULLSEC_THEMES_DIR = PLYMOUTH_DIR / 'nullsec-themes'
CONFIG_FILE = Path('/etc/nullsec/plymouth.conf')

THEME_VARIANTS = {
    'cyber': {
        'name': 'NullSec Cyber',
        'bg_color': '#0d1117',
        'fg_color': '#00ff41',
        'accent': '#00ffff',
        'style': 'matrix'
    },
    'stealth': {
        'name': 'NullSec Stealth',
        'bg_color': '#000000',
        'fg_color': '#333333',
        'accent': '#666666',
        'style': 'minimal'
    },
    'neon': {
        'name': 'NullSec Neon',
        'bg_color': '#0a0a0a',
        'fg_color': '#ff00ff',
        'accent': '#00ffff',
        'style': 'pulse'
    },
    'void': {
        'name': 'NullSec Void',
        'bg_color': '#000000',
        'fg_color': '#1a1a2e',
        'accent': '#e94560',
        'style': 'fade'
    },
    'ghost': {
        'name': 'NullSec Ghost',
        'bg_color': '#0f0f23',
        'fg_color': '#cccccc',
        'accent': '#ffff66',
        'style': 'glitch'
    },
    'blood': {
        'name': 'NullSec Blood',
        'bg_color': '#0d0d0d',
        'fg_color': '#8b0000',
        'accent': '#ff0000',
        'style': 'drip'
    },
    'ice': {
        'name': 'NullSec Ice',
        'bg_color': '#0a1628',
        'fg_color': '#4fc3f7',
        'accent': '#ffffff',
        'style': 'freeze'
    },
    'toxic': {
        'name': 'NullSec Toxic',
        'bg_color': '#0d1f0d',
        'fg_color': '#39ff14',
        'accent': '#adff2f',
        'style': 'bubble'
    },
}

# ============================================================================
# Theme Generation
# ============================================================================

def generate_plymouth_script(variant: str, config: dict) -> str:
    """Generate Plymouth script for a theme variant."""
    return f'''
# NullSec Plymouth Theme - {config["name"]}
# Generated by nullsec-plymouth

Window.SetBackgroundTopColor({hex_to_rgb(config["bg_color"])});
Window.SetBackgroundBottomColor({hex_to_rgb(config["bg_color"])});

# Logo
logo.image = Image("nullsec-logo.png");
logo.sprite = Sprite(logo.image);
logo.sprite.SetX(Window.GetWidth() / 2 - logo.image.GetWidth() / 2);
logo.sprite.SetY(Window.GetHeight() / 2 - logo.image.GetHeight() / 2 - 50);
logo.sprite.SetOpacity(1);

# Animation frames
for (i = 0; i < 32; i++) {{
    frames[i] = Image("frame-" + String(i).PadLeft(2, "0") + ".png");
}}

frame_idx = 0;
spinner.sprite = Sprite();
spinner.sprite.SetX(Window.GetWidth() / 2 - 64);
spinner.sprite.SetY(Window.GetHeight() / 2 + 50);

fun refresh_callback() {{
    spinner.sprite.SetImage(frames[frame_idx]);
    frame_idx = (frame_idx + 1) % 32;
}}

Plymouth.SetRefreshFunction(refresh_callback);

# Progress bar
progress_box.image = Image("progress_box.png");
progress_box.sprite = Sprite(progress_box.image);
progress_box.sprite.SetX(Window.GetWidth() / 2 - progress_box.image.GetWidth() / 2);
progress_box.sprite.SetY(Window.GetHeight() * 0.8);

progress_bar.original_image = Image("progress_bar.png");
progress_bar.sprite = Sprite();
progress_bar.sprite.SetX(Window.GetWidth() / 2 - progress_box.image.GetWidth() / 2 + 5);
progress_bar.sprite.SetY(Window.GetHeight() * 0.8 + 5);

fun progress_callback(duration, progress) {{
    if (progress_bar.image.GetWidth() != Math.Int(progress_bar.original_image.GetWidth() * progress)) {{
        progress_bar.image = progress_bar.original_image.Scale(Math.Int(progress_bar.original_image.GetWidth() * progress), progress_bar.original_image.GetHeight());
        progress_bar.sprite.SetImage(progress_bar.image);
    }}
}}

Plymouth.SetBootProgressFunction(progress_callback);

# Text messages
message_sprite = Sprite();
message_sprite.SetPosition(Window.GetWidth() / 2, Window.GetHeight() * 0.9, 1);

fun message_callback(text) {{
    message.image = Image.Text(text, {hex_to_rgb(config["fg_color"])});
    message_sprite.SetImage(message.image);
    message_sprite.SetX(Window.GetWidth() / 2 - message.image.GetWidth() / 2);
}}

Plymouth.SetMessageFunction(message_callback);
'''


def hex_to_rgb(hex_color: str) -> str:
    """Convert hex color to RGB values for Plymouth."""
    hex_color = hex_color.lstrip('#')
    r = int(hex_color[0:2], 16) / 255
    g = int(hex_color[2:4], 16) / 255
    b = int(hex_color[4:6], 16) / 255
    return f"{r:.2f}, {g:.2f}, {b:.2f}"


def generate_plymouth_file(variant: str, config: dict) -> str:
    """Generate .plymouth file for a theme variant."""
    return f'''[Plymouth Theme]
Name={config["name"]}
Description=NullSec Linux boot animation - {variant} variant
ModuleName=script

[script]
ImageDir=/usr/share/plymouth/themes/nullsec-{variant}
ScriptFile=/usr/share/plymouth/themes/nullsec-{variant}/nullsec.script
'''


def generate_frame(frame_num: int, config: dict, size: int = 128) -> str:
    """Generate ImageMagick command for animation frame."""
    angle = frame_num * (360 / 32)
    fg = config['fg_color']
    accent = config['accent']
    
    # Different animation styles
    style = config.get('style', 'matrix')
    
    if style == 'matrix':
        return f'''convert -size {size}x{size} xc:transparent \
            -fill "{fg}" -stroke "{accent}" -strokewidth 2 \
            -draw "translate {size//2},{size//2} rotate {angle} \
                   line 0,-{size//3} 0,{size//3} \
                   line -{size//3},0 {size//3},0" \
            -blur 0x1'''
    elif style == 'pulse':
        scale = 0.5 + 0.5 * abs((frame_num % 16 - 8) / 8)
        return f'''convert -size {size}x{size} xc:transparent \
            -fill "none" -stroke "{fg}" -strokewidth 3 \
            -draw "circle {size//2},{size//2} {size//2},{int(size*scale)}" '''
    elif style == 'glitch':
        offset = random.randint(-5, 5)
        return f'''convert -size {size}x{size} xc:transparent \
            -fill "{fg}" -font DejaVu-Sans-Bold -pointsize 48 \
            -gravity center -annotate +{offset}+0 "N" '''
    else:
        return f'''convert -size {size}x{size} xc:transparent \
            -fill "{fg}" -stroke "{accent}" -strokewidth 2 \
            -draw "translate {size//2},{size//2} rotate {angle} \
                   polygon 0,-{size//3} {size//6},{size//6} -{size//6},{size//6}" '''


def create_theme_variant(variant: str, verbose: bool = False) -> bool:
    """Create a Plymouth theme variant."""
    if variant not in THEME_VARIANTS:
        print(f"  {C.RED}[!] Unknown variant: {variant}{C.RST}")
        return False
    
    config = THEME_VARIANTS[variant]
    theme_dir = PLYMOUTH_DIR / f'nullsec-{variant}'
    
    if verbose:
        print(f"  {C.DIM}Creating theme: {config['name']}{C.RST}")
    
    try:
        theme_dir.mkdir(parents=True, exist_ok=True)
        
        # Write .plymouth file
        with open(theme_dir / f'nullsec-{variant}.plymouth', 'w') as f:
            f.write(generate_plymouth_file(variant, config))
        
        # Write script
        with open(theme_dir / 'nullsec.script', 'w') as f:
            f.write(generate_plymouth_script(variant, config))
        
        # Generate logo
        bg = config['bg_color']
        fg = config['fg_color']
        
        subprocess.run([
            'convert', '-size', '256x256', f'xc:{bg}',
            '-fill', fg, '-font', 'DejaVu-Sans-Bold', '-pointsize', '120',
            '-gravity', 'center', '-annotate', '+0+0', 'N',
            '-fill', 'none', '-stroke', fg, '-strokewidth', '4',
            '-draw', 'circle 128,128 128,20',
            str(theme_dir / 'nullsec-logo.png')
        ], capture_output=True)
        
        # Generate animation frames
        for i in range(32):
            frame_file = theme_dir / f'frame-{i:02d}.png'
            angle = i * (360 / 32)
            
            subprocess.run([
                'convert', '-size', '128x128', 'xc:transparent',
                '-fill', fg, '-stroke', config['accent'], '-strokewidth', '2',
                '-draw', f'translate 64,64 rotate {angle} polygon 0,-40 20,20 -20,20',
                str(frame_file)
            ], capture_output=True)
        
        # Generate progress bar
        subprocess.run([
            'convert', '-size', '310x20', f'xc:{bg}',
            '-fill', 'none', '-stroke', fg, '-strokewidth', '2',
            '-draw', 'rectangle 0,0 309,19',
            str(theme_dir / 'progress_box.png')
        ], capture_output=True)
        
        subprocess.run([
            'convert', '-size', '300x10', f'xc:{fg}',
            str(theme_dir / 'progress_bar.png')
        ], capture_output=True)
        
        return True
        
    except Exception as e:
        print(f"  {C.RED}[!] Error creating theme: {e}{C.RST}")
        return False


# ============================================================================
# Theme Management
# ============================================================================

def list_themes() -> list:
    """List all NullSec Plymouth themes."""
    themes = []
    for variant in THEME_VARIANTS:
        theme_dir = PLYMOUTH_DIR / f'nullsec-{variant}'
        if theme_dir.exists():
            themes.append(variant)
    return themes


def get_current_theme() -> str:
    """Get the currently active Plymouth theme."""
    try:
        result = subprocess.run(
            ['plymouth-set-default-theme'],
            capture_output=True,
            text=True
        )
        return result.stdout.strip()
    except Exception:
        return 'unknown'


def set_theme(variant: str) -> bool:
    """Set the active Plymouth theme."""
    theme_name = f'nullsec-{variant}'
    
    try:
        subprocess.run(
            ['plymouth-set-default-theme', theme_name],
            check=True,
            capture_output=True
        )
        
        # Update initramfs
        subprocess.run(
            ['update-initramfs', '-u'],
            capture_output=True
        )
        
        return True
    except Exception:
        return False


def set_random_theme() -> str:
    """Set a random theme and return its name."""
    themes = list_themes()
    if not themes:
        return None
    
    variant = random.choice(themes)
    if set_theme(variant):
        return variant
    return None


def enable_random_boot() -> bool:
    """Enable random theme selection at boot."""
    try:
        CONFIG_FILE.parent.mkdir(parents=True, exist_ok=True)
        
        with open(CONFIG_FILE, 'w') as f:
            f.write("RANDOM_THEME=true\n")
        
        # Create systemd service for random selection
        service_content = '''[Unit]
Description=NullSec Random Plymouth Theme
Before=plymouth-start.service

[Service]
Type=oneshot
ExecStart=/usr/local/bin/nullsec-plymouth --set-random
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
'''
        
        with open('/etc/systemd/system/nullsec-plymouth-random.service', 'w') as f:
            f.write(service_content)
        
        subprocess.run(['systemctl', 'daemon-reload'], capture_output=True)
        subprocess.run(['systemctl', 'enable', 'nullsec-plymouth-random.service'], capture_output=True)
        
        return True
    except Exception:
        return False


# ============================================================================
# CLI Interface
# ============================================================================

def print_banner():
    """Print application banner."""
    print(f"""
{C.CYN}  ╔═══════════════════════════════════════════════════════════╗
  ║                 NULLSEC PLYMOUTH                          ║
  ║              Boot Animation Manager                       ║
  ╚═══════════════════════════════════════════════════════════╝{C.RST}
""")


def interactive_menu():
    """Interactive theme selection menu."""
    while True:
        print(f"\n  {C.BLD}Available Themes:{C.RST}")
        print(f"  {C.DIM}{'─' * 50}{C.RST}")
        
        current = get_current_theme()
        themes = list_themes()
        
        for i, variant in enumerate(THEME_VARIANTS.keys(), 1):
            config = THEME_VARIANTS[variant]
            installed = '✓' if variant in themes else '○'
            active = f'{C.GRN}[ACTIVE]{C.RST}' if f'nullsec-{variant}' == current else ''
            
            color = C.GRN if variant in themes else C.DIM
            print(f"  {color}[{i}] {installed} {config['name']:20} {active}{C.RST}")
        
        print(f"\n  {C.CYN}[A]{C.RST} Install all themes")
        print(f"  {C.CYN}[R]{C.RST} Enable random at boot")
        print(f"  {C.CYN}[P]{C.RST} Preview current theme")
        print(f"  {C.CYN}[Q]{C.RST} Quit")
        
        choice = input(f"\n  {C.GRN}Select option:{C.RST} ").strip().lower()
        
        if choice == 'q':
            break
        elif choice == 'a':
            print(f"\n  {C.DIM}Installing all themes...{C.RST}")
            for variant in THEME_VARIANTS:
                if create_theme_variant(variant, verbose=True):
                    print(f"  {C.GRN}✓{C.RST} {THEME_VARIANTS[variant]['name']}")
            print(f"\n  {C.GRN}[+] All themes installed{C.RST}")
        elif choice == 'r':
            if enable_random_boot():
                print(f"  {C.GRN}[+] Random theme selection enabled{C.RST}")
            else:
                print(f"  {C.RED}[!] Failed to enable random selection{C.RST}")
        elif choice == 'p':
            subprocess.run(['plymouth', '--show-splash'], capture_output=True)
            input("  Press Enter to close preview...")
            subprocess.run(['plymouth', '--quit'], capture_output=True)
        elif choice.isdigit():
            idx = int(choice) - 1
            variants = list(THEME_VARIANTS.keys())
            if 0 <= idx < len(variants):
                variant = variants[idx]
                
                # Install if needed
                if variant not in themes:
                    print(f"  {C.DIM}Installing theme...{C.RST}")
                    create_theme_variant(variant, verbose=True)
                
                # Set as active
                print(f"  {C.DIM}Setting as default...{C.RST}")
                if set_theme(variant):
                    print(f"  {C.GRN}[+] Theme set: {THEME_VARIANTS[variant]['name']}{C.RST}")
                else:
                    print(f"  {C.RED}[!] Failed to set theme (run as root){C.RST}")


def main():
    """Main entry point."""
    import argparse
    
    parser = argparse.ArgumentParser(
        description='NullSec Plymouth - Boot Animation Manager'
    )
    parser.add_argument('--list', action='store_true',
                        help='List installed themes')
    parser.add_argument('--install', metavar='VARIANT',
                        help='Install a theme variant')
    parser.add_argument('--install-all', action='store_true',
                        help='Install all theme variants')
    parser.add_argument('--set', metavar='VARIANT',
                        help='Set active theme')
    parser.add_argument('--set-random', action='store_true',
                        help='Set a random theme')
    parser.add_argument('--enable-random', action='store_true',
                        help='Enable random theme at boot')
    parser.add_argument('--current', action='store_true',
                        help='Show current theme')
    
    args = parser.parse_args()
    
    # Check for root for most operations
    needs_root = args.install or args.install_all or args.set or args.set_random or args.enable_random
    if needs_root and os.geteuid() != 0:
        print(f"  {C.RED}[!] This operation requires root privileges{C.RST}")
        return 1
    
    if args.list:
        themes = list_themes()
        current = get_current_theme()
        print(f"\n  {C.BLD}Installed Themes:{C.RST}")
        for t in themes:
            active = ' [ACTIVE]' if f'nullsec-{t}' == current else ''
            print(f"  {C.GRN}•{C.RST} nullsec-{t}{active}")
        return 0
    
    if args.current:
        print(f"  Current theme: {get_current_theme()}")
        return 0
    
    if args.install:
        if create_theme_variant(args.install, verbose=True):
            print(f"  {C.GRN}[+] Theme installed{C.RST}")
        return 0
    
    if args.install_all:
        for variant in THEME_VARIANTS:
            create_theme_variant(variant, verbose=True)
        print(f"  {C.GRN}[+] All themes installed{C.RST}")
        return 0
    
    if args.set:
        if set_theme(args.set):
            print(f"  {C.GRN}[+] Theme set{C.RST}")
        else:
            print(f"  {C.RED}[!] Failed{C.RST}")
        return 0
    
    if args.set_random:
        variant = set_random_theme()
        if variant:
            print(f"  {C.GRN}[+] Random theme set: {variant}{C.RST}")
        return 0
    
    if args.enable_random:
        if enable_random_boot():
            print(f"  {C.GRN}[+] Random boot enabled{C.RST}")
        return 0
    
    # Default: interactive mode
    print_banner()
    interactive_menu()
    return 0


if __name__ == '__main__':
    sys.exit(main())
