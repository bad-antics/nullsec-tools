#!/bin/bash
# ============================================================================
# NullSec Forensics - Digital Forensics Toolkit
# ============================================================================
# File analysis, memory examination, and evidence collection
# Licensed under NullSec Public License v1.0
# ============================================================================

set -e

VERSION="1.0.0"
EVIDENCE_DIR="${EVIDENCE_DIR:-$HOME/nullsec-evidence}"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

banner() {
    echo -e "${CYAN}"
    cat << 'EOF'
    ╔═══════════════════════════════════════════════════════════════╗
    ║              NULLSEC FORENSICS v1.0                           ║
    ║              Digital Forensics Toolkit                        ║
    ╚═══════════════════════════════════════════════════════════════╝
EOF
    echo -e "${NC}"
}

log() { echo -e "${GREEN}[✓]${NC} $1"; }
warn() { echo -e "${YELLOW}[!]${NC} $1"; }
error() { echo -e "${RED}[✗]${NC} $1"; exit 1; }
info() { echo -e "${BLUE}[i]${NC} $1"; }

# Initialize evidence directory
init_evidence() {
    mkdir -p "$EVIDENCE_DIR"/{files,memory,network,logs,timeline}
    log "Evidence directory: $EVIDENCE_DIR"
}

# File analysis
analyze_file() {
    local file="$1"
    local report="$EVIDENCE_DIR/files/analysis_$TIMESTAMP.txt"
    
    [[ ! -f "$file" ]] && error "File not found: $file"
    
    info "Analyzing: $file"
    
    {
        echo "═══════════════════════════════════════════════════════════════"
        echo "NullSec Forensics - File Analysis Report"
        echo "Generated: $(date)"
        echo "File: $file"
        echo "═══════════════════════════════════════════════════════════════"
        echo ""
        
        echo "=== Basic Information ==="
        echo "Filename: $(basename "$file")"
        echo "Path: $(realpath "$file")"
        echo "Size: $(stat -c%s "$file" 2>/dev/null || stat -f%z "$file") bytes"
        echo "Permissions: $(stat -c%a "$file" 2>/dev/null || stat -f%p "$file")"
        echo "Owner: $(stat -c%U "$file" 2>/dev/null || stat -f%Su "$file")"
        echo ""
        
        echo "=== Timestamps ==="
        echo "Modified: $(stat -c%y "$file" 2>/dev/null || stat -f%Sm "$file")"
        echo "Accessed: $(stat -c%x "$file" 2>/dev/null || stat -f%Sa "$file")"
        echo "Changed: $(stat -c%z "$file" 2>/dev/null || stat -f%Sc "$file")"
        echo ""
        
        echo "=== File Type ==="
        file "$file"
        echo ""
        
        echo "=== Hashes ==="
        echo "MD5:    $(md5sum "$file" 2>/dev/null | cut -d' ' -f1)"
        echo "SHA1:   $(sha1sum "$file" 2>/dev/null | cut -d' ' -f1)"
        echo "SHA256: $(sha256sum "$file" 2>/dev/null | cut -d' ' -f1)"
        echo ""
        
        echo "=== Strings (first 50 printable) ==="
        strings "$file" 2>/dev/null | head -50
        echo ""
        
        echo "=== Hex Dump (first 256 bytes) ==="
        xxd "$file" 2>/dev/null | head -16
        echo ""
        
        # Check for embedded files
        if command -v binwalk &>/dev/null; then
            echo "=== Embedded Files (binwalk) ==="
            binwalk "$file" 2>/dev/null
            echo ""
        fi
        
        # Check for metadata
        if command -v exiftool &>/dev/null; then
            echo "=== Metadata (exiftool) ==="
            exiftool "$file" 2>/dev/null
        fi
        
    } > "$report"
    
    log "Report saved: $report"
    cat "$report"
}

# Memory snapshot
memory_snapshot() {
    local output="$EVIDENCE_DIR/memory/snapshot_$TIMESTAMP"
    mkdir -p "$output"
    
    info "Capturing memory snapshot..."
    
    # Process list
    ps auxf > "$output/processes.txt" 2>/dev/null
    log "Process list captured"
    
    # Open files
    lsof > "$output/open_files.txt" 2>/dev/null || true
    log "Open files captured"
    
    # Network connections
    ss -tunapl > "$output/network_connections.txt" 2>/dev/null || \
        netstat -tunapl > "$output/network_connections.txt" 2>/dev/null
    log "Network connections captured"
    
    # Memory maps for all processes
    for pid in /proc/[0-9]*; do
        pid_num=$(basename "$pid")
        cat "$pid/maps" > "$output/maps_$pid_num.txt" 2>/dev/null || true
    done
    log "Memory maps captured"
    
    # System memory info
    cat /proc/meminfo > "$output/meminfo.txt" 2>/dev/null
    free -h > "$output/free.txt" 2>/dev/null
    
    # Loaded kernel modules
    lsmod > "$output/modules.txt" 2>/dev/null
    
    log "Memory snapshot saved: $output"
}

# Network capture
network_capture() {
    local duration="${1:-60}"
    local interface="${2:-any}"
    local output="$EVIDENCE_DIR/network/capture_$TIMESTAMP.pcap"
    
    if ! command -v tcpdump &>/dev/null; then
        error "tcpdump not found. Install with: sudo apt install tcpdump"
    fi
    
    info "Capturing network traffic for ${duration}s on $interface..."
    
    sudo timeout "$duration" tcpdump -i "$interface" -w "$output" 2>/dev/null &
    local pid=$!
    
    # Progress
    for ((i=0; i<duration; i++)); do
        printf "\r[*] Capturing... %d/%d seconds" "$i" "$duration"
        sleep 1
    done
    echo ""
    
    wait $pid 2>/dev/null || true
    
    log "Capture saved: $output"
    log "Packets: $(tcpdump -r "$output" 2>/dev/null | wc -l)"
}

# System timeline
create_timeline() {
    local output="$EVIDENCE_DIR/timeline/timeline_$TIMESTAMP.csv"
    
    info "Creating filesystem timeline..."
    
    echo "timestamp,type,path,size,user" > "$output"
    
    # Find recently modified files
    find / -type f -mtime -7 2>/dev/null | while read -r file; do
        timestamp=$(stat -c%Y "$file" 2>/dev/null || echo "0")
        size=$(stat -c%s "$file" 2>/dev/null || echo "0")
        user=$(stat -c%U "$file" 2>/dev/null || echo "unknown")
        echo "$timestamp,modified,$file,$size,$user"
    done >> "$output" 2>/dev/null
    
    # Sort by timestamp
    sort -t',' -k1 -n "$output" -o "$output"
    
    log "Timeline saved: $output"
    log "Events: $(wc -l < "$output")"
}

# Log collection
collect_logs() {
    local output="$EVIDENCE_DIR/logs/logs_$TIMESTAMP"
    mkdir -p "$output"
    
    info "Collecting system logs..."
    
    # Auth logs
    cp /var/log/auth.log* "$output/" 2>/dev/null || true
    cp /var/log/secure* "$output/" 2>/dev/null || true
    
    # System logs
    cp /var/log/syslog* "$output/" 2>/dev/null || true
    cp /var/log/messages* "$output/" 2>/dev/null || true
    
    # Kernel logs
    dmesg > "$output/dmesg.txt" 2>/dev/null
    
    # Journal (systemd)
    journalctl --since "7 days ago" > "$output/journal.txt" 2>/dev/null || true
    
    # Failed logins
    lastb > "$output/failed_logins.txt" 2>/dev/null || true
    
    # Successful logins
    last > "$output/logins.txt" 2>/dev/null
    
    # Currently logged in
    who > "$output/who.txt" 2>/dev/null
    w > "$output/w.txt" 2>/dev/null
    
    log "Logs collected: $output"
}

# Hash directory
hash_directory() {
    local dir="$1"
    local output="$EVIDENCE_DIR/files/hashes_$TIMESTAMP.txt"
    
    [[ ! -d "$dir" ]] && error "Directory not found: $dir"
    
    info "Hashing directory: $dir"
    
    {
        echo "NullSec Forensics - Directory Hash Report"
        echo "Generated: $(date)"
        echo "Directory: $dir"
        echo "═══════════════════════════════════════════════════════════════"
        echo ""
    } > "$output"
    
    find "$dir" -type f -exec sha256sum {} \; >> "$output" 2>/dev/null
    
    log "Hashes saved: $output"
    log "Files hashed: $(grep -c '' "$output")"
}

# Full evidence collection
full_collection() {
    banner
    init_evidence
    
    info "Starting full evidence collection..."
    echo ""
    
    memory_snapshot
    echo ""
    
    collect_logs
    echo ""
    
    # Hash important directories
    for dir in /etc /var/log /home; do
        [[ -d "$dir" ]] && hash_directory "$dir"
    done
    echo ""
    
    # Create archive
    local archive="$HOME/nullsec-evidence-$TIMESTAMP.tar.gz"
    tar -czf "$archive" -C "$(dirname "$EVIDENCE_DIR")" "$(basename "$EVIDENCE_DIR")"
    
    log "Evidence archive: $archive"
    log "Size: $(du -h "$archive" | cut -f1)"
    
    echo ""
    info "Full collection complete!"
}

# Help
show_help() {
    banner
    cat << 'HELP'
USAGE:
    nullsec-forensics <command> [options]

COMMANDS:
    analyze <file>       Analyze a file (hashes, strings, metadata)
    memory              Capture memory snapshot
    network [secs]      Capture network traffic (default: 60s)
    timeline            Create filesystem timeline
    logs                Collect system logs
    hash <dir>          Hash all files in directory
    full                Full evidence collection
    help                Show this help

EXAMPLES:
    nullsec-forensics analyze suspicious.exe
    nullsec-forensics memory
    nullsec-forensics network 120
    sudo nullsec-forensics full

EVIDENCE DIRECTORY:
    Default: ~/nullsec-evidence
    Set with: EVIDENCE_DIR=/path/to/dir nullsec-forensics ...

LICENSE:
    NullSec Public License v1.0

HELP
}

# Main
main() {
    case "${1:-help}" in
        analyze)
            banner
            init_evidence
            analyze_file "$2"
            ;;
        memory)
            banner
            init_evidence
            memory_snapshot
            ;;
        network)
            banner
            init_evidence
            network_capture "${2:-60}" "${3:-any}"
            ;;
        timeline)
            banner
            init_evidence
            create_timeline
            ;;
        logs)
            banner
            init_evidence
            collect_logs
            ;;
        hash)
            banner
            init_evidence
            hash_directory "$2"
            ;;
        full)
            full_collection
            ;;
        *)
            show_help
            ;;
    esac
}

main "$@"
