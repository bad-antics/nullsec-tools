#!/bin/bash
# ============================================================================
# NullSec Update - Automated System Updates & Health Checks
# ============================================================================
# Comprehensive update manager for NullSec Linux
# Licensed under NullSec Public License v1.0
# ============================================================================

# ============================================================================

VERSION="1.0.0"
NULLSEC_DIR="$HOME/.local/bin"
NULLSEC_DATA="$HOME/.local/share/nullsec"
UPDATE_LOG="$NULLSEC_DATA/updates/update.log"
GITHUB_USER="bad-antics"
GITHUB_REPOS="nullsec-tools nullsec-windows nullsec-daily nullsec-configs nullsec-security"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
PURPLE='\033[0;35m'
NC='\033[0m'

banner() {
    echo -e "${CYAN}"
    cat << 'EOF'
    ╔═══════════════════════════════════════════════════════════════╗
    ║     _   _ _   _ _     _     ____  _____ ____                  ║
    ║    | \ | | | | | |   | |   / ___|| ____/ ___|                 ║
    ║    |  \| | | | | |   | |   \___ \|  _|| |                     ║
    ║    | |\  | |_| | |___| |___ ___) | |__| |___                  ║
    ║    |_| \_|\___/|_____|_____|____/|_____\____|                 ║
    ║                                                               ║
    ║              UPDATE & HEALTH CHECK SYSTEM v1.0                ║
    ╚═══════════════════════════════════════════════════════════════╝
EOF
    echo -e "${NC}"
}

log() { echo -e "${GREEN}[✓]${NC} $1"; echo "[$(date '+%Y-%m-%d %H:%M:%S')] [OK] $1" >> "$UPDATE_LOG"; }
warn() { echo -e "${YELLOW}[!]${NC} $1"; echo "[$(date '+%Y-%m-%d %H:%M:%S')] [WARN] $1" >> "$UPDATE_LOG"; }
error() { echo -e "${RED}[✗]${NC} $1"; echo "[$(date '+%Y-%m-%d %H:%M:%S')] [ERROR] $1" >> "$UPDATE_LOG"; }
info() { echo -e "${BLUE}[i]${NC} $1"; }

init() {
    mkdir -p "$NULLSEC_DATA"/{updates,backups,cache}
    touch "$UPDATE_LOG"
}

# ============================================================================
# HEALTH CHECKS
# ============================================================================

check_tools() {
    info "Checking NullSec tools integrity..."
    
    local total=0
    local valid=0
    local missing=0
    
    for tool in "$NULLSEC_DIR"/nullsec-*; do
        [[ ! -f "$tool" ]] && continue
        ((total++))
        
        local name=$(basename "$tool")
        
        # Check if executable
        if [[ ! -x "$tool" ]]; then
            warn "$name is not executable"
            chmod +x "$tool"
            log "Fixed permissions: $name"
        fi
        
        # Syntax check for bash scripts
        if head -1 "$tool" | grep -q "bash"; then
            if bash -n "$tool" 2>/dev/null; then
                ((valid++))
            else
                error "$name has syntax errors"
            fi
        else
            ((valid++))
        fi
    done
    
    echo ""
    log "Tools check: $valid/$total valid"
}

check_dependencies() {
    info "Checking system dependencies..."
    
    local deps=(
        "bash:Core shell"
        "curl:HTTP client"
        "git:Version control"
        "openssl:Cryptography"
        "gpg:Signing"
        "tar:Archives"
        "gzip:Compression"
        "jq:JSON processing"
    )
    
    local missing=0
    
    for dep in "${deps[@]}"; do
        local cmd="${dep%%:*}"
        local desc="${dep#*:}"
        
        if command -v "$cmd" &>/dev/null; then
            printf "  ${GREEN}✓${NC} %-12s %s\n" "$cmd" "$desc"
        else
            printf "  ${RED}✗${NC} %-12s %s ${RED}(MISSING)${NC}\n" "$cmd" "$desc"
            ((missing++))
        fi
    done
    
    echo ""
    if [[ $missing -eq 0 ]]; then
        log "All dependencies satisfied"
    else
        warn "$missing dependencies missing"
    fi
}

check_disk_space() {
    info "Checking disk space..."
    
    local available
    available=$(df -BG "$HOME" | tail -1 | awk '{print $4}' | tr -d 'G')
    
    if [[ $available -lt 1 ]]; then
        error "Critical: Less than 1GB free space!"
    elif [[ $available -lt 5 ]]; then
        warn "Low disk space: ${available}GB available"
    else
        log "Disk space OK: ${available}GB available"
    fi
}

check_network() {
    info "Checking network connectivity..."
    
    # Check GitHub
    if curl -s --max-time 5 https://github.com > /dev/null 2>&1; then
        log "GitHub: Connected"
    else
        warn "GitHub: Unreachable"
    fi
    
    # Check DNS
    if host github.com > /dev/null 2>&1; then
        log "DNS: Working"
    else
        warn "DNS: Issues detected"
    fi
}

check_security() {
    info "Running security checks..."
    
    local issues=0
    
    # Check for world-writable files in nullsec
    local writable
    writable=$(find "$NULLSEC_DIR" -name "nullsec-*" -perm -002 2>/dev/null | wc -l)
    if [[ $writable -gt 0 ]]; then
        warn "Found $writable world-writable NullSec files"
        ((issues++))
    fi
    
    # Check SSH key permissions
    if [[ -d "$HOME/.ssh" ]]; then
        local bad_perms
        bad_perms=$(find "$HOME/.ssh" -type f -perm /077 2>/dev/null | wc -l)
        if [[ $bad_perms -gt 0 ]]; then
            warn "SSH files have loose permissions"
            ((issues++))
        fi
    fi
    
    # Check for failed login attempts
    local failed_logins
    failed_logins=$(journalctl -q --since "24 hours ago" 2>/dev/null | grep -c "Failed password" 2>/dev/null || echo "0")
    failed_logins=$(echo "$failed_logins" | tr -d '\n' | head -c 10)
    if [[ "$failed_logins" =~ ^[0-9]+$ ]] && [[ $failed_logins -gt 10 ]]; then
        warn "High failed login attempts: $failed_logins in 24h"
        ((issues++))
    fi
    
    if [[ $issues -eq 0 ]]; then
        log "Security check: All clear"
    else
        warn "Security check: $issues issues found"
    fi
}

full_health_check() {
    banner
    echo -e "${PURPLE}═══ NullSec Health Check ═══${NC}"
    echo ""
    
    check_tools
    echo ""
    check_dependencies
    echo ""
    check_disk_space
    echo ""
    check_network
    echo ""
    check_security
    
    echo ""
    echo -e "${CYAN}═══════════════════════════════════════════════════════════════${NC}"
    log "Health check complete"
}

# ============================================================================
# UPDATES
# ============================================================================

backup_tools() {
    info "Creating backup..."
    
    local backup_file="$NULLSEC_DATA/backups/nullsec-backup-$(date +%Y%m%d_%H%M%S).tar.gz"
    
    tar -czf "$backup_file" -C "$NULLSEC_DIR" . 2>/dev/null
    
    log "Backup created: $backup_file"
    
    # Keep only last 5 backups
    ls -t "$NULLSEC_DATA/backups/"*.tar.gz 2>/dev/null | tail -n +6 | xargs rm -f 2>/dev/null || true
}

check_for_updates() {
    info "Checking for updates from GitHub..."
    
    local updates_available=0
    
    for repo in $GITHUB_REPOS; do
        local api_url="https://api.github.com/repos/$GITHUB_USER/$repo/commits/main"
        local remote_sha
        remote_sha=$(curl -s "$api_url" 2>/dev/null | jq -r '.sha // empty' 2>/dev/null | head -c 7)
        
        if [[ -n "$remote_sha" ]]; then
            local cache_file="$NULLSEC_DATA/cache/${repo}.sha"
            local local_sha=""
            [[ -f "$cache_file" ]] && local_sha=$(cat "$cache_file")
            
            if [[ "$remote_sha" != "$local_sha" ]]; then
                echo -e "  ${YELLOW}↑${NC} $repo: Update available ($remote_sha)"
                ((updates_available++))
            else
                echo -e "  ${GREEN}✓${NC} $repo: Up to date"
            fi
        else
            echo -e "  ${RED}?${NC} $repo: Could not check"
        fi
    done
    
    echo ""
    if [[ $updates_available -gt 0 ]]; then
        warn "$updates_available updates available"
        return 0
    else
        log "All repositories up to date"
        return 1
    fi
}

update_from_github() {
    local repo="$1"
    
    info "Updating $repo..."
    
    local temp_dir=$(mktemp -d)
    local clone_url="https://github.com/$GITHUB_USER/$repo.git"
    
    if git clone --depth 1 "$clone_url" "$temp_dir" 2>/dev/null; then
        # Handle different repo types
        case "$repo" in
            nullsec-tools)
                if [[ -d "$temp_dir/linux" ]]; then
                    cp -f "$temp_dir/linux/"nullsec-* "$NULLSEC_DIR/" 2>/dev/null || true
                    chmod +x "$NULLSEC_DIR/"nullsec-* 2>/dev/null
                    log "Updated Linux tools"
                fi
                ;;
            nullsec-windows)
                mkdir -p "$HOME/nullsec-release/windows"
                cp -f "$temp_dir/"*.ps1 "$HOME/nullsec-release/windows/" 2>/dev/null || true
                cp -f "$temp_dir/"*.bat "$HOME/nullsec-release/windows/" 2>/dev/null || true
                log "Updated Windows tools"
                ;;
            nullsec-daily)
                mkdir -p "$NULLSEC_DATA/daily"
                cp -rf "$temp_dir/features/"* "$NULLSEC_DATA/daily/" 2>/dev/null || true
                log "Updated daily features"
                ;;
            *)
                log "Synced $repo"
                ;;
        esac
        
        # Update cache
        local sha=$(git -C "$temp_dir" rev-parse --short HEAD 2>/dev/null)
        echo "$sha" > "$NULLSEC_DATA/cache/${repo}.sha"
        
        rm -rf "$temp_dir"
        return 0
    else
        error "Failed to clone $repo"
        rm -rf "$temp_dir"
        return 1
    fi
}

update_all() {
    banner
    echo -e "${PURPLE}═══ NullSec Update ═══${NC}"
    echo ""
    
    # Backup first
    backup_tools
    echo ""
    
    # Check and apply updates
    local updated=0
    
    for repo in $GITHUB_REPOS; do
        local api_url="https://api.github.com/repos/$GITHUB_USER/$repo/commits/main"
        local remote_sha
        remote_sha=$(curl -s "$api_url" 2>/dev/null | jq -r '.sha // empty' 2>/dev/null | head -c 7)
        
        if [[ -n "$remote_sha" ]]; then
            local cache_file="$NULLSEC_DATA/cache/${repo}.sha"
            local local_sha=""
            [[ -f "$cache_file" ]] && local_sha=$(cat "$cache_file")
            
            if [[ "$remote_sha" != "$local_sha" ]]; then
                if update_from_github "$repo"; then
                    ((updated++))
                fi
            fi
        fi
    done
    
    echo ""
    if [[ $updated -gt 0 ]]; then
        log "Updated $updated repositories"
    else
        log "No updates applied"
    fi
}

# ============================================================================
# SYSTEM PACKAGE UPDATES
# ============================================================================

update_system() {
    info "Updating system packages..."
    
    if command -v apt &>/dev/null; then
        sudo apt update && sudo apt upgrade -y
    elif command -v dnf &>/dev/null; then
        sudo dnf upgrade -y
    elif command -v pacman &>/dev/null; then
        sudo pacman -Syu --noconfirm
    elif command -v xbps-install &>/dev/null; then
        sudo xbps-install -Syu
    else
        warn "Unknown package manager"
        return 1
    fi
    
    log "System packages updated"
}

# ============================================================================
# SCHEDULED AUTOMATION
# ============================================================================

setup_auto_updates() {
    info "Setting up automatic updates..."
    
    # Create systemd service
    mkdir -p "$HOME/.config/systemd/user"
    
    cat > "$HOME/.config/systemd/user/nullsec-update.service" << EOF
[Unit]
Description=NullSec Automatic Update
After=network-online.target
Wants=network-online.target

[Service]
Type=oneshot
ExecStart=$NULLSEC_DIR/nullsec-update auto
StandardOutput=append:$UPDATE_LOG
StandardError=append:$UPDATE_LOG

[Install]
WantedBy=default.target
EOF

    # Create timer (runs daily at 3 AM)
    cat > "$HOME/.config/systemd/user/nullsec-update.timer" << EOF
[Unit]
Description=NullSec Daily Update Timer

[Timer]
OnCalendar=*-*-* 03:00:00
Persistent=true
RandomizedDelaySec=1800

[Install]
WantedBy=timers.target
EOF

    # Create health check timer (runs every 6 hours)
    cat > "$HOME/.config/systemd/user/nullsec-health.service" << EOF
[Unit]
Description=NullSec Health Check
After=network-online.target

[Service]
Type=oneshot
ExecStart=$NULLSEC_DIR/nullsec-update health --quiet
StandardOutput=append:$UPDATE_LOG
StandardError=append:$UPDATE_LOG
EOF

    cat > "$HOME/.config/systemd/user/nullsec-health.timer" << EOF
[Unit]
Description=NullSec Health Check Timer

[Timer]
OnCalendar=*-*-* 00/6:00:00
Persistent=true

[Install]
WantedBy=timers.target
EOF

    # Enable timers
    systemctl --user daemon-reload
    systemctl --user enable --now nullsec-update.timer 2>/dev/null || true
    systemctl --user enable --now nullsec-health.timer 2>/dev/null || true
    
    log "Automatic updates configured"
    info "  - Updates: Daily at 3:00 AM"
    info "  - Health checks: Every 6 hours"
}

show_timers() {
    info "NullSec scheduled tasks:"
    echo ""
    systemctl --user list-timers nullsec-* 2>/dev/null || echo "No timers found"
}

# ============================================================================
# AUTO MODE (for cron/systemd)
# ============================================================================

auto_mode() {
    echo "═══ NullSec Auto Update: $(date) ═══" >> "$UPDATE_LOG"
    
    # Quick health check
    local issues=0
    
    # Check tools
    for tool in "$NULLSEC_DIR"/nullsec-*; do
        [[ ! -x "$tool" ]] && chmod +x "$tool" 2>/dev/null
    done
    
    # Check for updates silently
    for repo in $GITHUB_REPOS; do
        local api_url="https://api.github.com/repos/$GITHUB_USER/$repo/commits/main"
        local remote_sha
        remote_sha=$(curl -s "$api_url" 2>/dev/null | jq -r '.sha // empty' 2>/dev/null | head -c 7)
        
        if [[ -n "$remote_sha" ]]; then
            local cache_file="$NULLSEC_DATA/cache/${repo}.sha"
            local local_sha=""
            [[ -f "$cache_file" ]] && local_sha=$(cat "$cache_file")
            
            if [[ "$remote_sha" != "$local_sha" ]]; then
                update_from_github "$repo" >> "$UPDATE_LOG" 2>&1
            fi
        fi
    done
    
    echo "═══ Auto update complete ═══" >> "$UPDATE_LOG"
}

# ============================================================================
# STATUS & REPORTING
# ============================================================================

show_status() {
    banner
    
    echo -e "${CYAN}═══ NullSec Status ═══${NC}"
    echo ""
    
    # Tool count
    local tool_count
    tool_count=$(ls "$NULLSEC_DIR"/nullsec-* 2>/dev/null | wc -l)
    echo -e "Tools installed:    ${GREEN}$tool_count${NC}"
    
    # Last update
    local last_update
    last_update=$(grep -m1 "Auto update complete\|Updated" "$UPDATE_LOG" 2>/dev/null | head -1 | cut -d']' -f1 | tr -d '[')
    echo -e "Last update:        ${last_update:-Never}"
    
    # Disk usage
    local disk_usage
    disk_usage=$(du -sh "$NULLSEC_DIR" 2>/dev/null | cut -f1)
    echo -e "Tools disk usage:   $disk_usage"
    
    # Backup count
    local backup_count
    backup_count=$(ls "$NULLSEC_DATA/backups/"*.tar.gz 2>/dev/null | wc -l)
    echo -e "Backups available:  $backup_count"
    
    echo ""
    echo -e "${CYAN}═══ Repository Status ═══${NC}"
    echo ""
    
    for repo in $GITHUB_REPOS; do
        local cache_file="$NULLSEC_DATA/cache/${repo}.sha"
        if [[ -f "$cache_file" ]]; then
            local sha=$(cat "$cache_file")
            printf "  %-20s %s\n" "$repo" "$sha"
        else
            printf "  %-20s %s\n" "$repo" "(not synced)"
        fi
    done
    
    echo ""
    echo -e "${CYAN}═══ Scheduled Tasks ═══${NC}"
    echo ""
    systemctl --user list-timers nullsec-* --no-pager 2>/dev/null | head -10 || echo "  No timers configured"
}

view_log() {
    local lines="${1:-50}"
    
    if [[ -f "$UPDATE_LOG" ]]; then
        tail -n "$lines" "$UPDATE_LOG"
    else
        info "No update log found"
    fi
}

# ============================================================================
# HELP
# ============================================================================

show_help() {
    banner
    cat << 'HELP'
USAGE:
    nullsec-update <command> [options]

HEALTH COMMANDS:
    health              Full system health check
    check-tools         Verify NullSec tools integrity
    check-deps          Check system dependencies
    check-security      Run security audit

UPDATE COMMANDS:
    check               Check for available updates
    update              Download and apply updates
    update-system       Update system packages (apt/dnf/pacman)
    backup              Create tools backup

AUTOMATION:
    setup-auto          Configure automatic updates
    timers              Show scheduled tasks
    auto                Run automated update (for cron)

STATUS:
    status              Show NullSec status overview
    log [lines]         View update log (default: 50 lines)

OPTIONS:
    --quiet, -q         Minimal output (for scripts)
    --force, -f         Force update even if up-to-date

EXAMPLES:
    nullsec-update health
    nullsec-update update
    nullsec-update setup-auto
    nullsec-update log 100

SCHEDULED UPDATES:
    After running 'setup-auto':
    - Updates run daily at 3:00 AM
    - Health checks run every 6 hours

LICENSE:
    NullSec Public License v1.0

HELP
}

# ============================================================================
# MAIN
# ============================================================================

main() {
    init
    
    local quiet=false
    local force=false
    
    # Parse flags
    for arg in "$@"; do
        case "$arg" in
            --quiet|-q) quiet=true ;;
            --force|-f) force=true ;;
        esac
    done
    
    case "${1:-help}" in
        health|check-health)
            full_health_check
            ;;
        check-tools)
            banner
            check_tools
            ;;
        check-deps|deps)
            banner
            check_dependencies
            ;;
        check-security|security)
            banner
            check_security
            ;;
        check)
            banner
            check_for_updates
            ;;
        update|upgrade)
            update_all
            ;;
        update-system|system)
            banner
            update_system
            ;;
        backup)
            banner
            backup_tools
            ;;
        setup-auto|auto-setup)
            banner
            setup_auto_updates
            ;;
        timers)
            banner
            show_timers
            ;;
        auto)
            auto_mode
            ;;
        status)
            show_status
            ;;
        log)
            view_log "${2:-50}"
            ;;
        *)
            show_help
            ;;
    esac
}

main "$@"
